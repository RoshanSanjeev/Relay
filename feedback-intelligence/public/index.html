<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Feedback Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f0f0f;
      color: #e5e5e5;
      line-height: 1.6;
      letter-spacing: -0.3px;
      overflow: hidden;
    }

    /* Premium gradient background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #0d0d0d 100%);
      z-index: -1;
      pointer-events: none;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: rgba(15, 15, 15, 0.5);
      position: relative;
    }

    /* ========== HEADER ========== */
    header {
      background: rgba(10, 10, 10, 0.6);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(243, 128, 32, 0.1);
      padding: 20px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(to right, transparent, #F38020, transparent);
      opacity: 0.3;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-brand h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 32px;
      font-weight: 700;
      color: #F38020;
      letter-spacing: -1px;
      line-height: 1;
    }

    .header-brand p {
      font-size: 12px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1.2px;
    }

    .header-controls {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .mock-data-badge {
      background: rgba(243, 128, 32, 0.08);
      border: 1px solid rgba(243, 128, 32, 0.25);
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      color: #F38020;
      font-weight: 600;
      letter-spacing: 0.3px;
      display: flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(10px);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .mock-data-badge:hover {
      border-color: rgba(243, 128, 32, 0.5);
      background: rgba(243, 128, 32, 0.12);
    }

    .button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.3px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
    }

    .button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.1);
      transition: left 0.3s ease;
      z-index: -1;
    }

    .button:hover::before {
      left: 100%;
    }

    .button.primary {
      background: #F38020;
      color: #000;
      box-shadow: 0 8px 24px rgba(243, 128, 32, 0.2);
    }

    .button.primary:hover {
      box-shadow: 0 12px 32px rgba(243, 128, 32, 0.3);
      transform: translateY(-2px);
    }

    .button.secondary {
      background: rgba(255, 255, 255, 0.08);
      color: #e5e5e5;
      border: 1px solid rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
    }

    .button.secondary:hover {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(255, 255, 255, 0.25);
    }

    /* ========== CONTENT ========== */
    .content {
      display: flex;
      flex: 1;
      overflow: hidden;
      gap: 0;
    }

    /* ========== DRAGGABLE DIVIDER ========== */
    /* ========== UNIFIED CONTROL SYSTEM ========== */
    :root {
      --control-idle: rgba(243, 128, 32, 0.08);
      --control-hover: rgba(243, 128, 32, 0.16);
      --control-active: rgba(243, 128, 32, 0.28);
      --control-transition: cubic-bezier(0.34, 1.56, 0.64, 1);
      --control-transition-duration: 0.25s;
    }

    /* ========== HORIZONTAL DIVIDER (col-resize) ========== */
    .divider {
      width: 8px;
      background: linear-gradient(90deg,
        transparent 0%,
        var(--control-idle) 50%,
        transparent 100%);
      cursor: col-resize;
      transition: background 0.25s var(--control-transition), box-shadow 0.25s ease;
      position: relative;
      flex-shrink: 0;
      border-left: 1px solid rgba(243, 128, 32, 0.05);
      border-right: 1px solid rgba(243, 128, 32, 0.05);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .divider::before {
      content: '';
      position: absolute;
      width: 2px;
      height: 24px;
      background: rgba(243, 128, 32, 0.15);
      border-radius: 2px;
      transition: all 0.25s var(--control-transition);
    }

    .divider:hover {
      background: linear-gradient(90deg,
        transparent 0%,
        var(--control-hover) 50%,
        transparent 100%);
      box-shadow: inset 0 0 8px rgba(243, 128, 32, 0.08);
    }

    .divider:hover::before {
      height: 32px;
      background: rgba(243, 128, 32, 0.25);
      box-shadow: 0 0 8px rgba(243, 128, 32, 0.15);
    }

    .divider.dragging {
      background: linear-gradient(90deg,
        transparent 0%,
        var(--control-active) 50%,
        transparent 100%);
      box-shadow: inset 0 0 12px rgba(243, 128, 32, 0.12);
    }

    .divider.dragging::before {
      height: 40px;
      background: rgba(243, 128, 32, 0.35);
      box-shadow: 0 0 12px rgba(243, 128, 32, 0.25);
    }

    /* ========== VERTICAL DIVIDER (row-resize) ========== */
    .v-divider {
      height: 8px;
      background: linear-gradient(180deg,
        transparent 0%,
        var(--control-idle) 50%,
        transparent 100%);
      cursor: row-resize;
      transition: background 0.25s var(--control-transition), box-shadow 0.25s ease;
      position: relative;
      flex-shrink: 0;
      border-top: 1px solid rgba(243, 128, 32, 0.05);
      border-bottom: 1px solid rgba(243, 128, 32, 0.05);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .v-divider::before {
      content: '';
      position: absolute;
      height: 2px;
      width: 24px;
      background: rgba(243, 128, 32, 0.15);
      border-radius: 2px;
      transition: all 0.25s var(--control-transition);
    }

    .v-divider:hover {
      background: linear-gradient(180deg,
        transparent 0%,
        var(--control-hover) 50%,
        transparent 100%);
      box-shadow: inset 0 0 8px rgba(243, 128, 32, 0.08);
    }

    .v-divider:hover::before {
      width: 32px;
      background: rgba(243, 128, 32, 0.25);
      box-shadow: 0 0 8px rgba(243, 128, 32, 0.15);
    }

    .v-divider.dragging {
      background: linear-gradient(180deg,
        transparent 0%,
        var(--control-active) 50%,
        transparent 100%);
      box-shadow: inset 0 0 12px rgba(243, 128, 32, 0.12);
    }

    .v-divider.dragging::before {
      width: 40px;
      background: rgba(243, 128, 32, 0.35);
      box-shadow: 0 0 12px rgba(243, 128, 32, 0.25);
    }

    /* ========== LEFT PANEL - AI CHAT ========== */
    .left-panel {
      flex: 0 0 48%;
      display: flex;
      flex-direction: column;
      background: rgba(20, 20, 20, 0.4);
      position: relative;
      min-width: 300px;
    }

    .left-panel::after {
      content: '';
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 1px;
      background: linear-gradient(to bottom, transparent, rgba(243, 128, 32, 0.2), transparent);
      pointer-events: none;
    }

    .panel-header {
      padding: 28px 28px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      background: linear-gradient(to bottom, rgba(30, 30, 30, 0.8), rgba(20, 20, 20, 0.4));
    }

    .panel-header h2 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 28px;
      font-weight: 600;
      color: #fff;
      letter-spacing: -0.5px;
      margin-bottom: 6px;
    }

    .panel-header p {
      font-size: 12px;
      color: #777;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      font-weight: 500;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px 28px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* ========== UNIFIED SCROLLBAR SYSTEM ========== */
    .chat-container::-webkit-scrollbar {
      width: 8px;
    }

    .chat-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-container::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg,
        rgba(243, 128, 32, 0.12),
        rgba(243, 128, 32, 0.18));
      border-radius: 4px;
      border: 1px solid rgba(243, 128, 32, 0.08);
      background-clip: padding-box;
      transition: background 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .chat-container::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg,
        rgba(243, 128, 32, 0.22),
        rgba(243, 128, 32, 0.32));
      box-shadow: inset 0 0 6px rgba(243, 128, 32, 0.1);
    }

    .chat-container::-webkit-scrollbar-thumb:active {
      background: linear-gradient(180deg,
        rgba(243, 128, 32, 0.28),
        rgba(243, 128, 32, 0.42));
    }

    .messages-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 24px;
    }

    .message {
      display: flex;
      gap: 12px;
      animation: slideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      justify-content: flex-end;
    }

    .bubble {
      max-width: 85%;
      padding: 14px 18px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .message.ai .bubble {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #d5d5d5;
      backdrop-filter: blur(10px);
    }

    .message.user .bubble {
      background: #F38020;
      color: #000;
      font-weight: 500;
      letter-spacing: 0.2px;
      box-shadow: 0 4px 16px rgba(243, 128, 32, 0.2);
    }

    .quick-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .quick-action-label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    .quick-action-btn {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(243, 128, 32, 0.15);
      color: #d5d5d5;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
      font-weight: 500;
    }

    .quick-action-btn:hover {
      background: rgba(243, 128, 32, 0.1);
      border-color: rgba(243, 128, 32, 0.35);
      transform: translateX(4px);
    }

    .input-area {
      padding: 20px 28px 28px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      gap: 12px;
    }

    .input-wrapper {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-wrapper input {
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #fff;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-family: 'Inter', sans-serif;
      transition: all 0.3s ease;
      outline: none;
    }

    .input-wrapper input::placeholder {
      color: #666;
    }

    .input-wrapper input:focus {
      border-color: rgba(243, 128, 32, 0.4);
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 20px rgba(243, 128, 32, 0.1);
    }

    /* ========== RIGHT PANEL - BROWSER ========== */
    .right-panel {
      flex: 0 0 52%;
      display: flex;
      flex-direction: column;
      background: rgba(15, 15, 15, 0.3);
      position: relative;
      min-width: 300px;
      overflow: hidden;
    }

    .right-panel-content {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }

    .filters-container {
      padding: 28px 28px 20px;
      background: linear-gradient(to bottom, rgba(30, 30, 30, 0.5), rgba(20, 20, 20, 0.2));
      overflow-y: auto;
      flex: 0 0 200px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .filters-container::-webkit-scrollbar {
      width: 8px;
    }

    .filters-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .filters-container::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg,
        rgba(243, 128, 32, 0.12),
        rgba(243, 128, 32, 0.18));
      border-radius: 4px;
      border: 1px solid rgba(243, 128, 32, 0.08);
      background-clip: padding-box;
      transition: background 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .filters-container::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg,
        rgba(243, 128, 32, 0.22),
        rgba(243, 128, 32, 0.32));
      box-shadow: inset 0 0 6px rgba(243, 128, 32, 0.1);
    }

    .filters-container::-webkit-scrollbar-thumb:active {
      background: linear-gradient(180deg,
        rgba(243, 128, 32, 0.28),
        rgba(243, 128, 32, 0.42));
    }

    .filter-section {
      margin-bottom: 24px;
    }

    .filter-section:last-child {
      margin-bottom: 0;
    }

    .filter-label {
      font-size: 11px;
      color: #F38020;
      text-transform: uppercase;
      letter-spacing: 1.1px;
      font-weight: 700;
      margin-bottom: 12px;
      display: block;
    }

    .filter-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 11px 14px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 7px;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .filter-option:hover {
      background: rgba(243, 128, 32, 0.08);
      border-color: rgba(243, 128, 32, 0.25);
      transform: translateX(3px);
    }

    .filter-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: #F38020;
    }

    .filter-option label {
      flex: 1;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .filter-count {
      font-size: 12px;
      color: #888;
      font-weight: 500;
    }

    .sort-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sort-select {
      width: 100%;
      padding: 12px 14px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 7px;
      color: #e5e5e5;
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23F38020' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .sort-select:hover {
      background-color: rgba(243, 128, 32, 0.08);
      border-color: rgba(243, 128, 32, 0.25);
    }

    .sort-select:focus {
      outline: none;
      border-color: #F38020;
      box-shadow: 0 0 0 2px rgba(243, 128, 32, 0.15);
    }

    .sort-select option {
      background: #1a1a1a;
      color: #e5e5e5;
      padding: 10px;
    }

    .results-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px 28px;
    }

    .results-container::-webkit-scrollbar {
      width: 8px;
    }

    .results-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .results-container::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg,
        rgba(243, 128, 32, 0.12),
        rgba(243, 128, 32, 0.18));
      border-radius: 4px;
      border: 1px solid rgba(243, 128, 32, 0.08);
      background-clip: padding-box;
      transition: background 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .results-container::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg,
        rgba(243, 128, 32, 0.22),
        rgba(243, 128, 32, 0.32));
      box-shadow: inset 0 0 6px rgba(243, 128, 32, 0.1);
    }

    .results-container::-webkit-scrollbar-thumb:active {
      background: linear-gradient(180deg,
        rgba(243, 128, 32, 0.28),
        rgba(243, 128, 32, 0.42));
    }

    .results-header {
      font-family: 'Cormorant Garamond', serif;
      font-size: 16px;
      font-weight: 600;
      color: #F38020;
      margin-bottom: 16px;
      letter-spacing: -0.3px;
    }

    .feedback-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .feedback-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
    }

    .feedback-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: #F38020;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .feedback-item:hover {
      background: rgba(243, 128, 32, 0.08);
      border-color: rgba(243, 128, 32, 0.3);
      transform: translateX(4px);
    }

    .feedback-item:hover::before {
      opacity: 1;
    }

    .feedback-source {
      font-size: 11px;
      color: #F38020;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      font-weight: 700;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .feedback-date {
      font-size: 10px;
      color: #666;
      font-weight: 500;
      text-transform: none;
      letter-spacing: 0;
    }

    .feedback-text {
      font-size: 13px;
      color: #d5d5d5;
      line-height: 1.5;
      margin-bottom: 10px;
    }

    .feedback-meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.08);
      color: #aaa;
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-weight: 500;
    }

    .badge.sentiment-positive {
      background: rgba(34, 197, 94, 0.12);
      color: #22c55e;
      border-color: rgba(34, 197, 94, 0.25);
    }

    .badge.sentiment-negative {
      background: rgba(239, 68, 68, 0.12);
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.25);
    }

    .badge.urgency-critical {
      background: rgba(220, 38, 38, 0.15);
      color: #dc2626;
      border-color: rgba(220, 38, 38, 0.3);
      font-weight: 600;
    }

    .badge.urgency-high {
      background: rgba(249, 115, 22, 0.15);
      color: #f97316;
      border-color: rgba(249, 115, 22, 0.3);
    }

    .badge.urgency-medium {
      background: rgba(234, 179, 8, 0.15);
      color: #eab308;
      border-color: rgba(234, 179, 8, 0.3);
    }

    .badge.urgency-low {
      background: rgba(34, 197, 94, 0.12);
      color: #22c55e;
      border-color: rgba(34, 197, 94, 0.25);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    /* ========== AI ANALYSIS STEPS ========== */
    .ai-analysis {
      padding: 16px;
      background: rgba(20, 20, 20, 0.6);
      border-radius: 12px;
      border: 1px solid rgba(243, 128, 32, 0.1);
    }

    .ai-response {
      margin-bottom: 16px;
      padding: 14px 16px;
      background: linear-gradient(135deg, rgba(243, 128, 32, 0.08) 0%, rgba(20, 20, 20, 0.4) 100%);
      border-radius: 10px;
      border-left: 3px solid #F38020;
    }

    .ai-response-text {
      font-size: 14px;
      color: #e5e5e5;
      line-height: 1.6;
      margin-bottom: 8px;
    }

    .ai-response-detail {
      font-size: 12px;
      color: #aaa;
      line-height: 1.5;
      margin-bottom: 8px;
      padding-left: 12px;
      border-left: 2px solid rgba(255, 255, 255, 0.1);
    }

    .ai-response-recommendation {
      font-size: 12px;
      color: #22c55e;
      line-height: 1.5;
      padding: 8px 10px;
      background: rgba(34, 197, 94, 0.08);
      border-radius: 6px;
      margin-top: 8px;
    }

    .ai-step {
      margin-bottom: 16px;
      padding-left: 36px;
      position: relative;
    }

    .ai-step:last-child { margin-bottom: 0; }

    .ai-step::before {
      content: '';
      position: absolute;
      left: 11px;
      top: 28px;
      bottom: -16px;
      width: 2px;
      background: rgba(255, 255, 255, 0.1);
    }

    .ai-step:last-child::before { display: none; }

    .ai-step-num {
      position: absolute;
      left: 0;
      top: 0;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      background: rgba(255, 255, 255, 0.1);
      color: #666;
      border: 1px dashed rgba(255, 255, 255, 0.2);
    }

    .ai-step-num.active {
      background: rgba(243, 128, 32, 0.2);
      color: #F38020;
      border: 2px solid #F38020;
      animation: stepPulse 1.5s ease-in-out infinite;
    }

    .ai-step-num.done {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border: 2px solid #22c55e;
    }

    @keyframes stepPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(243, 128, 32, 0.4); }
      50% { box-shadow: 0 0 0 6px rgba(243, 128, 32, 0); }
    }

    .ai-step-title {
      font-size: 13px;
      font-weight: 600;
      color: #e5e5e5;
      margin-bottom: 6px;
    }

    .ai-step.pending .ai-step-title { color: #666; }

    .ai-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .ai-chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      background: rgba(243, 128, 32, 0.08);
      border: 1px solid rgba(243, 128, 32, 0.15);
      border-radius: 14px;
      font-size: 11px;
      color: #aaa;
      animation: chipIn 0.3s ease forwards;
    }

    @keyframes chipIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .ai-chip.done {
      background: rgba(34, 197, 94, 0.1);
      border-color: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .ai-chip.active {
      background: rgba(243, 128, 32, 0.15);
      border-color: rgba(243, 128, 32, 0.3);
      color: #F38020;
    }

    .ai-progress {
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      margin: 12px 0;
      overflow: hidden;
    }

    .ai-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #F38020, #22c55e);
      border-radius: 2px;
      transition: width 0.4s ease;
    }

    .ai-insight {
      margin-top: 12px;
      padding: 12px;
      background: rgba(243, 128, 32, 0.05);
      border-left: 3px solid #F38020;
      border-radius: 0 8px 8px 0;
    }

    .ai-insight-label {
      font-size: 10px;
      font-weight: 700;
      color: #F38020;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 6px;
    }

    .ai-insight-text {
      font-size: 13px;
      color: #d5d5d5;
      line-height: 1.5;
    }

    .ai-action {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-top: 8px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 6px;
    }

    .ai-priority {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      flex-shrink: 0;
    }

    .ai-priority.p1 { background: rgba(220, 38, 38, 0.2); color: #dc2626; }
    .ai-priority.p2 { background: rgba(249, 115, 22, 0.2); color: #f97316; }
    .ai-priority.p3 { background: rgba(234, 179, 8, 0.2); color: #eab308; }

    .ai-action-text {
      font-size: 12px;
      color: #ccc;
      line-height: 1.4;
    }

    .ai-sources {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .ai-sources-label {
      font-size: 10px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .ai-source-btn {
      background: rgba(243, 128, 32, 0.1);
      border: 1px solid rgba(243, 128, 32, 0.2);
      color: #F38020;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      margin: 0 6px 6px 0;
      transition: all 0.2s ease;
    }

    .ai-source-btn:hover {
      background: rgba(243, 128, 32, 0.2);
      transform: translateY(-1px);
    }

    /* ========== AI INSIGHTS REFINED ========== */
    @keyframes insightReveal {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes subtleGlow {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(243, 128, 32, 0);
      }
      50% {
        box-shadow: 0 0 20px -5px rgba(243, 128, 32, 0.15);
      }
    }

    .insights-container {
      margin-top: 20px;
      animation: insightReveal 0.4s ease-out forwards;
    }

    .ai-powered-section {
      position: relative;
      margin-bottom: 16px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(243, 128, 32, 0.04) 0%, rgba(243, 128, 32, 0.01) 100%);
      border: 1px solid rgba(243, 128, 32, 0.12);
      border-radius: 12px;
      overflow: hidden;
    }

    .ai-powered-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(243, 128, 32, 0.4), transparent);
    }

    .ai-powered-header {
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: 'Cormorant Garamond', serif;
      font-size: 14px;
      font-weight: 600;
      color: #b8b8b8;
      letter-spacing: 0.3px;
      margin-bottom: 14px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .ai-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      background: linear-gradient(135deg, rgba(243, 128, 32, 0.18) 0%, rgba(243, 128, 32, 0.08) 100%);
      border: 1px solid rgba(243, 128, 32, 0.25);
      border-radius: 4px;
      font-family: 'Inter', sans-serif;
      font-size: 9px;
      font-weight: 700;
      color: #F38020;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .ai-badge::before {
      content: '◆';
      font-size: 6px;
      opacity: 0.8;
    }

    .ai-insight.ai-generated {
      position: relative;
      background: linear-gradient(135deg, rgba(243, 128, 32, 0.06) 0%, rgba(20, 20, 20, 0.8) 100%);
      border: 1px solid rgba(243, 128, 32, 0.1);
      border-left: 3px solid #F38020;
      border-radius: 0 10px 10px 0;
      animation: subtleGlow 3s ease-in-out infinite;
      margin-top: 10px;
    }

    .ai-insight.ai-generated:first-of-type {
      margin-top: 0;
    }

    .ai-insight.ai-generated .ai-insight-label {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ai-insight.ai-generated .ai-insight-text {
      color: #e0e0e0;
      font-size: 13px;
      line-height: 1.6;
    }

    .ai-insight.ai-generated .ai-insight-text strong {
      font-weight: 600;
    }

    .results-preview {
      margin-top: 16px;
      padding-top: 14px;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .results-preview-header {
      font-size: 9px;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    .results-preview-item {
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.04);
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .results-preview-item:last-child {
      margin-bottom: 0;
    }

    .results-preview-item:hover {
      background: rgba(255, 255, 255, 0.04);
      border-color: rgba(243, 128, 32, 0.15);
      transform: translateX(2px);
    }

    /* ========== SOURCE ACCORDION ========== */
    .ai-sources-expandable {
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .source-accordion {
      margin-bottom: 8px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 8px;
      overflow: hidden;
      transition: all 0.2s ease;
    }

    .source-accordion:hover {
      border-color: rgba(243, 128, 32, 0.2);
    }

    .source-accordion-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.02);
      border: none;
      color: #e5e5e5;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .source-accordion-btn:hover {
      background: rgba(243, 128, 32, 0.08);
    }

    .source-count {
      font-size: 11px;
      color: #888;
      font-weight: 400;
    }

    .accordion-arrow {
      font-size: 9px;
      color: #666;
      transition: transform 0.2s ease;
    }

    .source-accordion.expanded .accordion-arrow {
      transform: rotate(90deg);
      color: #F38020;
    }

    .source-accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .source-accordion.expanded .source-accordion-content {
      max-height: 500px;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .source-message-item {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }

    .source-message-item:last-child {
      border-bottom: none;
    }

    .source-message-meta {
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .source-message-text {
      font-size: 12px;
      color: #ccc;
      line-height: 1.5;
    }

    .source-message-author {
      font-size: 10px;
      color: #666;
      margin-top: 4px;
      font-style: italic;
    }

    .source-more {
      padding: 8px 12px;
      font-size: 11px;
      color: #F38020;
      text-align: center;
      background: rgba(243, 128, 32, 0.05);
    }

    /* ========== LOADING ========== */
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(243, 128, 32, 0.2);
      border-top-color: #F38020;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ========== SOURCE LOGOS ========== */
    .source-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .source-icon svg {
      width: 14px;
      height: 14px;
    }

    .source-icon.discord svg { fill: #5865F2; }
    .source-icon.twitter svg { fill: #e5e5e5; }
    .source-icon.github svg { fill: #e5e5e5; }
    .source-icon.email svg { fill: #F38020; }
    .source-icon.support svg { fill: #22c55e; }

    /* ========== AI AGENT SYSTEM ========== */
    .agent-workflow {
      margin-bottom: 16px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(15, 15, 15, 0.9) 0%, rgba(25, 25, 25, 0.9) 100%);
      border: 1px solid rgba(243, 128, 32, 0.15);
      border-radius: 12px;
    }

    .agent-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .agent-system-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: linear-gradient(135deg, rgba(243, 128, 32, 0.2) 0%, rgba(243, 128, 32, 0.08) 100%);
      border: 1px solid rgba(243, 128, 32, 0.3);
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
      color: #F38020;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .agent-system-badge svg {
      width: 12px;
      height: 12px;
      fill: #F38020;
    }

    .agent-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 15px;
      font-weight: 600;
      color: #b8b8b8;
      letter-spacing: 0.2px;
    }

    .agent-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .agent-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .agent-item.active {
      background: rgba(243, 128, 32, 0.06);
      border-color: rgba(243, 128, 32, 0.2);
    }

    .agent-item.complete {
      background: rgba(34, 197, 94, 0.04);
      border-color: rgba(34, 197, 94, 0.15);
    }

    .agent-icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #666;
    }

    .agent-item.active .agent-icon {
      background: rgba(243, 128, 32, 0.15);
      border-color: rgba(243, 128, 32, 0.3);
      color: #F38020;
      animation: agentPulse 1.5s ease-in-out infinite;
    }

    .agent-item.complete .agent-icon {
      background: rgba(34, 197, 94, 0.15);
      border-color: rgba(34, 197, 94, 0.3);
      color: #22c55e;
    }

    @keyframes agentPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(243, 128, 32, 0.3); }
      50% { box-shadow: 0 0 0 4px rgba(243, 128, 32, 0); }
    }

    .agent-details {
      flex: 1;
      min-width: 0;
    }

    .agent-name {
      font-size: 12px;
      font-weight: 600;
      color: #e5e5e5;
      margin-bottom: 3px;
    }

    .agent-item.pending .agent-name {
      color: #666;
    }

    .agent-status {
      font-size: 11px;
      color: #888;
    }

    .agent-item.active .agent-status {
      color: #F38020;
    }

    .agent-item.complete .agent-status {
      color: #22c55e;
    }

    .agent-output {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    .agent-output-tag {
      font-size: 10px;
      padding: 2px 6px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      color: #aaa;
    }

    .agent-item.complete .agent-output-tag {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
    }

    /* Web search indicator */
    .web-search-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 10px;
      margin-top: 10px;
      background: rgba(59, 130, 246, 0.08);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 6px;
      font-size: 11px;
      color: #60a5fa;
    }

    .web-search-indicator svg {
      width: 12px;
      height: 12px;
      fill: #60a5fa;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 1200px) {
      .left-panel {
        flex: 0 0 45%;
      }
      .right-panel {
        flex: 0 0 55%;
      }
    }

    @media (max-width: 768px) {
      .content {
        flex-direction: column;
      }

      .left-panel {
        flex: 0 0 50%;
        border-right: none;
        border-bottom: 1px solid rgba(243, 128, 32, 0.08);
      }

      .right-panel {
        flex: 0 0 50%;
      }
    }
  </style>
</head>

<body>
  <div class="app-container">
    <!-- HEADER -->
    <header>
      <div class="header-brand">
        <h1>Feedback Intelligence</h1>
        <p>Multi-Agent AI System</p>
      </div>
      <div class="header-controls">
        <div class="mock-data-badge">
          <span class="source-icon"><svg viewBox="0 0 24 24" fill="#F38020"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg></span>
          <span id="mockDataCount">0 items</span>
        </div>
        <button class="button primary" id="generateMockBtn">+ Add 20 Feedback Items</button>
      </div>
    </header>

    <!-- CONTENT -->
    <div class="content" id="content">
      <!-- LEFT PANEL -->
      <div class="left-panel" id="leftPanel">
        <div class="panel-header">
          <h2>AI Agent System</h2>
          <p>Multi-Agent Analysis Pipeline</p>
        </div>

        <div class="chat-container">
          <div class="messages-area" id="messagesArea"></div>

          <div class="quick-actions" id="quickActions">
            <div class="quick-action-label">Quick Analysis</div>
            <button class="quick-action-btn" data-prompt="What are my critical blockers that need immediate attention?">Critical Blockers</button>
            <button class="quick-action-btn" data-prompt="Give me an overview of negative feedback trends and patterns">Negative Trends</button>
            <button class="quick-action-btn" data-prompt="What feature requests are customers asking for?">Feature Requests</button>
            <button class="quick-action-btn" data-prompt="Show me a summary of all feedback sources and sentiment distribution">Feedback Overview</button>
          </div>
        </div>

        <div class="input-area">
          <div class="input-wrapper">
            <input type="text" id="aiInput" placeholder="Ask about your feedback..." />
          </div>
          <button class="button primary" id="sendBtn" style="padding: 12px 20px;">Send</button>
        </div>
      </div>

      <!-- DRAGGABLE DIVIDER -->
      <div class="divider" id="divider"></div>

      <!-- RIGHT PANEL -->
      <div class="right-panel" id="rightPanel">
        <div class="panel-header">
          <h2>Browse Feedback</h2>
          <p>Filter by Source & Sentiment</p>
        </div>

        <div class="right-panel-content" id="rightPanelContent">
          <div class="filters-container" id="filtersContainer">
          <div class="filter-section">
            <label class="filter-label">Source</label>
            <div class="filter-options">
              <div class="filter-option active" data-source="all">
                <input type="checkbox" id="filter-all" checked />
                <label for="filter-all">
                  <span>All Sources</span>
                </label>
              </div>
              <div class="filter-option" data-source="email">
                <input type="checkbox" id="filter-email" />
                <label for="filter-email">
                  <span><span class="source-icon email"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg></span> Email</span>
                  <span class="filter-count" id="count-email">0</span>
                </label>
              </div>
              <div class="filter-option" data-source="discord">
                <input type="checkbox" id="filter-discord" />
                <label for="filter-discord">
                  <span><span class="source-icon discord"><svg viewBox="0 0 24 24"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg></span> Discord</span>
                  <span class="filter-count" id="count-discord">0</span>
                </label>
              </div>
              <div class="filter-option" data-source="support-ticket">
                <input type="checkbox" id="filter-support" />
                <label for="filter-support">
                  <span><span class="source-icon support"><svg viewBox="0 0 24 24"><path d="M11.5 2C6.81 2 3 5.81 3 10.5S6.81 19 11.5 19h.5v3c4.86-2.34 8-7 8-11.5C20 5.81 16.19 2 11.5 2zm1 14.5h-2v-2h2v2zm0-3.5h-2c0-3.25 3-3 3-5 0-1.1-.9-2-2-2s-2 .9-2 2h-2c0-2.21 1.79-4 4-4s4 1.79 4 4c0 2.5-3 2.75-3 5z"/></svg></span> Support</span>
                  <span class="filter-count" id="count-support">0</span>
                </label>
              </div>
              <div class="filter-option" data-source="twitter">
                <input type="checkbox" id="filter-twitter" />
                <label for="filter-twitter">
                  <span><span class="source-icon twitter"><svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></span> X / Twitter</span>
                  <span class="filter-count" id="count-twitter">0</span>
                </label>
              </div>
              <div class="filter-option" data-source="github-issue">
                <input type="checkbox" id="filter-github" />
                <label for="filter-github">
                  <span><span class="source-icon github"><svg viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></span> GitHub</span>
                  <span class="filter-count" id="count-github">0</span>
                </label>
              </div>
            </div>
          </div>

          <div class="filter-section">
            <label class="filter-label">Sentiment</label>
            <div class="filter-options">
              <div class="filter-option" data-sentiment="positive">
                <input type="checkbox" id="filter-positive" />
                <label for="filter-positive">
                  <span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#22c55e;margin-right:6px;"></span>Positive</span>
                  <span class="filter-count" id="count-positive">0</span>
                </label>
              </div>
              <div class="filter-option" data-sentiment="neutral">
                <input type="checkbox" id="filter-neutral" />
                <label for="filter-neutral">
                  <span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#888;margin-right:6px;"></span>Neutral</span>
                  <span class="filter-count" id="count-neutral">0</span>
                </label>
              </div>
              <div class="filter-option" data-sentiment="negative">
                <input type="checkbox" id="filter-negative" />
                <label for="filter-negative">
                  <span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#ef4444;margin-right:6px;"></span>Negative</span>
                  <span class="filter-count" id="count-negative">0</span>
                </label>
              </div>
            </div>
          </div>

          <div class="filter-section">
            <label class="filter-label">Urgency</label>
            <div class="filter-options">
              <div class="filter-option" data-urgency="critical">
                <input type="checkbox" id="filter-critical" />
                <label for="filter-critical">
                  <span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#dc2626;margin-right:6px;"></span>Critical</span>
                  <span class="filter-count" id="count-critical">0</span>
                </label>
              </div>
              <div class="filter-option" data-urgency="high">
                <input type="checkbox" id="filter-high" />
                <label for="filter-high">
                  <span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#f97316;margin-right:6px;"></span>High</span>
                  <span class="filter-count" id="count-high">0</span>
                </label>
              </div>
              <div class="filter-option" data-urgency="medium">
                <input type="checkbox" id="filter-medium" />
                <label for="filter-medium">
                  <span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#eab308;margin-right:6px;"></span>Medium</span>
                  <span class="filter-count" id="count-medium">0</span>
                </label>
              </div>
              <div class="filter-option" data-urgency="low">
                <input type="checkbox" id="filter-low" />
                <label for="filter-low">
                  <span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#22c55e;margin-right:6px;"></span>Low</span>
                  <span class="filter-count" id="count-low">0</span>
                </label>
              </div>
            </div>
          </div>

          <div class="filter-section">
            <label class="filter-label">Sort By</label>
            <div class="sort-options">
              <select id="sortSelect" class="sort-select">
                <option value="date-desc">Newest First</option>
                <option value="date-asc">Oldest First</option>
                <option value="urgency-desc">Urgency (High → Low)</option>
                <option value="urgency-asc">Urgency (Low → High)</option>
                <option value="sentiment-neg">Negative First</option>
                <option value="sentiment-pos">Positive First</option>
              </select>
            </div>
          </div>
        </div>

        <!-- VERTICAL DIVIDER -->
        <div class="v-divider" id="vDivider"></div>

        <div class="results-container" id="resultsContainer">
          <div class="results-header" id="resultsHeader">All Feedback</div>
          <div class="feedback-list" id="feedbackList"></div>
        </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const mockFeedback = [
      // CRITICAL ISSUES - Blockers
      { content: 'Login completely broken, blocking all user access since this morning', source: 'support-ticket', sentiment: 'negative', urgency: 'critical', author: 'Support Lead' },
      { content: 'Mobile app crashes on startup after latest update, cannot access anything', source: 'twitter', sentiment: 'negative', urgency: 'critical', author: '@enterprise_user' },
      { content: 'Payment processing failing for all customers, revenue impact immediate', source: 'support-ticket', sentiment: 'negative', urgency: 'critical', author: 'Billing Team' },
      { content: 'Data export feature corrupting files, critical for compliance deadline', source: 'email', sentiment: 'negative', urgency: 'critical', author: 'Legal Dept' },
      { content: 'SSO integration broken after your last deployment, 500 users locked out', source: 'support-ticket', sentiment: 'negative', urgency: 'critical', author: 'IT Admin' },

      // HIGH PRIORITY - Urgent but not blocking
      { content: 'API docs are outdated and missing examples for v3 endpoints', source: 'github-issue', sentiment: 'negative', urgency: 'high', author: 'Senior Dev' },
      { content: 'Performance is slow during peak hours, 10s+ load times reported', source: 'twitter', sentiment: 'negative', urgency: 'high', author: '@techreview' },
      { content: 'Webhook deliveries failing intermittently, affecting our automation', source: 'github-issue', sentiment: 'negative', urgency: 'high', author: 'Integration Lead' },
      { content: 'Search functionality returning incorrect results for complex queries', source: 'support-ticket', sentiment: 'negative', urgency: 'high', author: 'Power User' },
      { content: 'Dashboard widgets not loading for some team members', source: 'discord', sentiment: 'negative', urgency: 'high', author: 'Team Lead' },
      { content: 'CSV import failing silently for files over 10MB', source: 'email', sentiment: 'negative', urgency: 'high', author: 'Data Analyst' },

      // FEATURE REQUESTS - Medium priority
      { content: 'Would love dark mode support, working late nights is painful', source: 'discord', sentiment: 'neutral', urgency: 'medium', author: 'Night Owl Dev' },
      { content: 'Slack integration would be powerful for our workflow', source: 'github-issue', sentiment: 'positive', urgency: 'medium', author: 'DevOps Engineer' },
      { content: 'Need ability to customize email notification templates', source: 'email', sentiment: 'neutral', urgency: 'medium', author: 'Marketing Manager' },
      { content: 'Requesting bulk edit functionality for managing large datasets', source: 'support-ticket', sentiment: 'neutral', urgency: 'medium', author: 'Operations' },
      { content: 'Would be great to have keyboard shortcuts for power users', source: 'discord', sentiment: 'positive', urgency: 'medium', author: 'Productivity Geek' },
      { content: 'API rate limits are too restrictive for our use case, need higher tier', source: 'github-issue', sentiment: 'negative', urgency: 'medium', author: 'Tech Lead' },
      { content: 'Mobile app needs offline mode for field workers', source: 'email', sentiment: 'neutral', urgency: 'medium', author: 'Field Operations' },
      { content: 'Requesting two-factor authentication options beyond SMS', source: 'support-ticket', sentiment: 'neutral', urgency: 'medium', author: 'Security Officer' },

      // PRICING & BILLING CONCERNS
      { content: 'Pricing is higher than competitors, hard to justify to leadership', source: 'email', sentiment: 'negative', urgency: 'medium', author: 'Procurement' },
      { content: 'Need more flexible pricing tiers for small teams', source: 'discord', sentiment: 'negative', urgency: 'medium', author: 'Startup Founder' },
      { content: 'Billing page confusing, accidentally upgraded wrong account', source: 'support-ticket', sentiment: 'negative', urgency: 'high', author: 'Finance' },
      { content: 'Would appreciate annual billing discount option', source: 'email', sentiment: 'neutral', urgency: 'low', author: 'CFO Office' },

      // POSITIVE FEEDBACK - Happy customers
      { content: 'New dashboard design is amazing, very intuitive and clean', source: 'discord', sentiment: 'positive', urgency: 'low', author: 'Happy User #234' },
      { content: 'Excellent customer support response time, issue resolved in 10 min', source: 'email', sentiment: 'positive', urgency: 'low', author: 'Satisfied Client' },
      { content: 'Works well for our enterprise needs, scaling beautifully', source: 'support-ticket', sentiment: 'positive', urgency: 'low', author: 'Enterprise PM' },
      { content: 'The new analytics features are exactly what we needed', source: 'twitter', sentiment: 'positive', urgency: 'low', author: '@datadriven' },
      { content: 'Onboarding flow is smooth, team was productive in hours not days', source: 'email', sentiment: 'positive', urgency: 'low', author: 'New Customer' },
      { content: 'API is well-designed and easy to integrate with', source: 'github-issue', sentiment: 'positive', urgency: 'low', author: 'Backend Dev' },
      { content: 'Love the recent performance improvements, noticeably faster', source: 'discord', sentiment: 'positive', urgency: 'low', author: 'Long-time User' },
      { content: 'Your product helped us reduce manual work by 60%', source: 'email', sentiment: 'positive', urgency: 'low', author: 'COO' },

      // DOCUMENTATION & ONBOARDING
      { content: 'Getting started guide is incomplete, missing key steps', source: 'github-issue', sentiment: 'negative', urgency: 'medium', author: 'New Developer' },
      { content: 'Video tutorials would help visual learners like me', source: 'discord', sentiment: 'neutral', urgency: 'low', author: 'Visual Learner' },
      { content: 'API changelog should be more detailed about breaking changes', source: 'github-issue', sentiment: 'negative', urgency: 'medium', author: 'Integration Dev' },
      { content: 'FAQ section answered all my questions, well organized', source: 'email', sentiment: 'positive', urgency: 'low', author: 'Self-Service User' },

      // SECURITY CONCERNS
      { content: 'Need SOC2 compliance documentation for our audit', source: 'email', sentiment: 'neutral', urgency: 'high', author: 'Compliance Officer' },
      { content: 'Concerned about data residency, need EU-only option', source: 'support-ticket', sentiment: 'negative', urgency: 'high', author: 'GDPR Lead' },
      { content: 'Requesting audit logs for all admin actions', source: 'github-issue', sentiment: 'neutral', urgency: 'medium', author: 'Security Team' },
      { content: 'Password policy should enforce stronger requirements', source: 'email', sentiment: 'negative', urgency: 'medium', author: 'IT Security' },

      // UX/UI FEEDBACK
      { content: 'Navigation is confusing, took 5 clicks to find settings', source: 'discord', sentiment: 'negative', urgency: 'medium', author: 'UX Critic' },
      { content: 'Color contrast issues making text hard to read', source: 'support-ticket', sentiment: 'negative', urgency: 'medium', author: 'Accessibility User' },
      { content: 'Love the clean interface, not cluttered like competitors', source: 'twitter', sentiment: 'positive', urgency: 'low', author: '@designlover' },
      { content: 'Modal dialogs are too small on high-res displays', source: 'github-issue', sentiment: 'negative', urgency: 'low', author: '4K User' },

      // INTEGRATION REQUESTS
      { content: 'Zapier integration would unlock so many automations for us', source: 'discord', sentiment: 'positive', urgency: 'medium', author: 'Automation Fan' },
      { content: 'Need native Salesforce connector for our sales team', source: 'email', sentiment: 'neutral', urgency: 'high', author: 'Sales Ops' },
      { content: 'Jira integration is buggy, tickets not syncing properly', source: 'github-issue', sentiment: 'negative', urgency: 'high', author: 'Scrum Master' },
      { content: 'Google Workspace SSO setup was seamless, great job', source: 'email', sentiment: 'positive', urgency: 'low', author: 'IT Admin' },

      // GENERAL COMPLAINTS
      { content: 'Too many emails from your system, need better notification controls', source: 'twitter', sentiment: 'negative', urgency: 'low', author: '@inbox_zero' },
      { content: 'App keeps logging me out, very frustrating', source: 'support-ticket', sentiment: 'negative', urgency: 'medium', author: 'Frequent User' },
      { content: 'Loading spinner shows forever on slow connections', source: 'discord', sentiment: 'negative', urgency: 'medium', author: 'Remote Worker' },
    ];

    let allFeedback = [];
    let selectedSources = new Set(['all']);
    let selectedSentiments = new Set();
    let selectedUrgencies = new Set();
    let currentSort = 'date-desc';

    // Urgency priority for sorting
    const urgencyOrder = { 'critical': 4, 'high': 3, 'medium': 2, 'low': 1 };
    const sentimentOrder = { 'negative': 3, 'neutral': 2, 'positive': 1 };

    /* ========== DRAGGABLE DIVIDER ========== */
    let isDragging = false;
    const divider = document.getElementById('divider');
    const content = document.getElementById('content');
    const leftPanel = document.getElementById('leftPanel');
    const rightPanel = document.getElementById('rightPanel');

    divider.addEventListener('mousedown', () => {
      isDragging = true;
      divider.classList.add('dragging');
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;

      const contentRect = content.getBoundingClientRect();
      const newLeftWidth = e.clientX - contentRect.left;
      const totalWidth = contentRect.width;

      // Constrain to minimum widths
      if (newLeftWidth < 300 || totalWidth - newLeftWidth < 300) return;

      const leftPercent = (newLeftWidth / totalWidth) * 100;
      const rightPercent = 100 - leftPercent - 0.5; // 0.5% for divider

      leftPanel.style.flex = `0 0 ${leftPercent}%`;
      rightPanel.style.flex = `0 0 ${rightPercent}%`;
    });

    document.addEventListener('mouseup', () => {
      if (isDragging) {
        isDragging = false;
        divider.classList.remove('dragging');
        document.body.style.cursor = 'default';
        document.body.style.userSelect = 'auto';
      }
    });

    /* ========== VERTICAL DIVIDER (filters vs results) ========== */
    let isVDragging = false;
    const vDivider = document.getElementById('vDivider');
    const rightPanelContent = document.getElementById('rightPanelContent');
    const filtersContainer = document.getElementById('filtersContainer');
    const resultsContainer = document.getElementById('resultsContainer');

    vDivider.addEventListener('mousedown', () => {
      isVDragging = true;
      vDivider.classList.add('dragging');
      document.body.style.cursor = 'row-resize';
      document.body.style.userSelect = 'none';
    });

    document.addEventListener('mousemove', (e) => {
      if (!isVDragging) return;

      const contentRect = rightPanelContent.getBoundingClientRect();
      const newFiltersHeight = e.clientY - contentRect.top;
      const totalHeight = contentRect.height;

      // Constrain to minimum heights (50px for filters, 100px for results)
      if (newFiltersHeight < 50 || totalHeight - newFiltersHeight < 100) return;

      const filtersPercent = (newFiltersHeight / totalHeight) * 100;
      const resultsPercent = 100 - filtersPercent - 0.5; // 0.5% for divider

      filtersContainer.style.flex = `0 0 ${filtersPercent}%`;
      resultsContainer.style.flex = `0 0 ${resultsPercent}%`;
    });

    document.addEventListener('mouseup', () => {
      if (isVDragging) {
        isVDragging = false;
        vDivider.classList.remove('dragging');
        document.body.style.cursor = 'default';
        document.body.style.userSelect = 'auto';
      }
    });

    async function init() {
      await loadFeedback();
      updateCounts();
      displayFeedback();
      setupEventListeners();
      addMessage('ai', `<div style="font-size: 13px;">
        <div style="margin-bottom: 10px;">
          <span style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: linear-gradient(135deg, rgba(243, 128, 32, 0.2) 0%, rgba(243, 128, 32, 0.08) 100%); border: 1px solid rgba(243, 128, 32, 0.3); border-radius: 6px; font-size: 10px; font-weight: 700; color: #F38020; text-transform: uppercase; letter-spacing: 0.8px;">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="#F38020"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
            Multi-Agent System Active
          </span>
        </div>
        <div style="margin-bottom: 8px;"><strong>Welcome, PM!</strong> I'm your AI-powered feedback analysis system.</div>
        <div style="color: #aaa; font-size: 12px; margin-bottom: 10px;">I use multiple specialized agents to analyze your feedback:</div>
        <div style="color: #ccc; font-size: 12px; margin-bottom: 4px;">🎯 <strong>Query Classifier</strong> — Understands your intent</div>
        <div style="color: #ccc; font-size: 12px; margin-bottom: 4px;">📊 <strong>Data Retrieval</strong> — Queries Cloudflare D1</div>
        <div style="color: #ccc; font-size: 12px; margin-bottom: 4px;">🧠 <strong>Sentiment Analysis</strong> — Uses distilbert model</div>
        <div style="color: #ccc; font-size: 12px; margin-bottom: 10px;">💡 <strong>PM Insight</strong> — Llama 3.1 for recommendations</div>
        <div style="color: #888; font-size: 11px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">Try: "What are my critical blockers?" or "Show negative trends"</div>
      </div>`, true);
    }

    async function loadFeedback() {
      try {
        const response = await fetch('/api/feedback?limit=1000');
        const data = await response.json();
        allFeedback = data.data || [];
        updateMockDataCount();
      } catch (error) {
        console.error('Failed to load:', error);
      }
    }

    function updateMockDataCount() {
      document.getElementById('mockDataCount').textContent = `${allFeedback.length} items`;
    }

    async function generateMockData() {
      const btn = document.getElementById('generateMockBtn');
      btn.disabled = true;
      btn.textContent = 'Adding...';

      try {
        // Shuffle and pick 20 random items
        const shuffled = [...mockFeedback].sort(() => Math.random() - 0.5);
        const items = shuffled.slice(0, 20);

        for (const fb of items) {
          await fetch('/api/feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(fb),
          });
        }
        await loadFeedback();
        updateCounts();
        displayFeedback();
      } finally {
        btn.disabled = false;
        btn.textContent = '+ Add 20 Feedback Items';
      }
    }

    function updateCounts() {
      const counts = { email: 0, discord: 0, 'support-ticket': 0, twitter: 0, 'github-issue': 0, positive: 0, neutral: 0, negative: 0, critical: 0, high: 0, medium: 0, low: 0 };
      allFeedback.forEach(item => {
        if (counts[item.source] !== undefined) counts[item.source]++;
        if (counts[item.sentiment] !== undefined) counts[item.sentiment]++;
        if (counts[item.urgency] !== undefined) counts[item.urgency]++;
      });
      Object.entries(counts).forEach(([key, count]) => {
        const el = document.getElementById(`count-${key}`);
        if (el) el.textContent = count;
      });
    }

    function displayFeedback() {
      const sources = selectedSources.has('all') ? null : Array.from(selectedSources);
      const sentiments = selectedSentiments.size > 0 ? Array.from(selectedSentiments) : null;
      const urgencies = selectedUrgencies.size > 0 ? Array.from(selectedUrgencies) : null;

      let filtered = allFeedback.filter(item => {
        const sourceMatch = !sources || sources.includes(item.source);
        const sentimentMatch = !sentiments || sentiments.includes(item.sentiment);
        const urgencyMatch = !urgencies || urgencies.includes(item.urgency);
        return sourceMatch && sentimentMatch && urgencyMatch;
      });

      // Apply sorting
      filtered = sortFeedback(filtered, currentSort);

      const list = document.getElementById('feedbackList');
      const header = document.getElementById('resultsHeader');

      if (filtered.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-state-icon" style="font-size: 32px; color: #666;">—</div><p>No results</p></div>';
        header.textContent = 'No feedback found';
        return;
      }

      header.textContent = `Showing ${filtered.length} result${filtered.length !== 1 ? 's' : ''}`;
      list.innerHTML = filtered.map(item => {
        const dateStr = item.created_at ? formatDate(item.created_at) : '';
        return `
        <div class="feedback-item">
          <div class="feedback-source">${getSourceIcon(item.source)} ${item.source}${dateStr ? ` <span class="feedback-date">${dateStr}</span>` : ''}</div>
          <div class="feedback-text">${escapeHtml(item.content)}</div>
          <div class="feedback-meta">
            <span class="badge sentiment-${item.sentiment}">${item.sentiment}</span>
            <span class="badge urgency-${item.urgency}">${item.urgency}</span>
            ${item.author ? `<span class="badge">${item.author}</span>` : ''}
          </div>
        </div>
      `}).join('');
    }

    function sortFeedback(items, sortType) {
      const sorted = [...items];
      switch (sortType) {
        case 'date-desc':
          return sorted.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
        case 'date-asc':
          return sorted.sort((a, b) => new Date(a.created_at || 0) - new Date(b.created_at || 0));
        case 'urgency-desc':
          return sorted.sort((a, b) => (urgencyOrder[b.urgency] || 0) - (urgencyOrder[a.urgency] || 0));
        case 'urgency-asc':
          return sorted.sort((a, b) => (urgencyOrder[a.urgency] || 0) - (urgencyOrder[b.urgency] || 0));
        case 'sentiment-neg':
          return sorted.sort((a, b) => (sentimentOrder[b.sentiment] || 0) - (sentimentOrder[a.sentiment] || 0));
        case 'sentiment-pos':
          return sorted.sort((a, b) => (sentimentOrder[a.sentiment] || 0) - (sentimentOrder[b.sentiment] || 0));
        default:
          return sorted;
      }
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays}d ago`;
      if (diffDays < 30) return `${Math.floor(diffDays / 7)}w ago`;
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function getSourceIcon(source) {
      const icons = {
        email: '<span class="source-icon email"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg></span>',
        discord: '<span class="source-icon discord"><svg viewBox="0 0 24 24"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg></span>',
        'support-ticket': '<span class="source-icon support"><svg viewBox="0 0 24 24"><path d="M11.5 2C6.81 2 3 5.81 3 10.5S6.81 19 11.5 19h.5v3c4.86-2.34 8-7 8-11.5C20 5.81 16.19 2 11.5 2zm1 14.5h-2v-2h2v2zm0-3.5h-2c0-3.25 3-3 3-5 0-1.1-.9-2-2-2s-2 .9-2 2h-2c0-2.21 1.79-4 4-4s4 1.79 4 4c0 2.5-3 2.75-3 5z"/></svg></span>',
        twitter: '<span class="source-icon twitter"><svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></span>',
        'github-issue': '<span class="source-icon github"><svg viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></span>'
      };
      return icons[source] || '<span class="source-icon"><svg viewBox="0 0 24 24" fill="#888"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 12h-2v-2h2v2zm0-4h-2V6h2v4z"/></svg></span>';
    }

    // Keep emoji version for backwards compatibility in some places
    function getEmoji(source) {
      return getSourceIcon(source);
    }

    function setupEventListeners() {
      document.getElementById('generateMockBtn').addEventListener('click', generateMockData);
      document.getElementById('sendBtn').addEventListener('click', sendMessage);
      document.getElementById('aiInput').addEventListener('keypress', (e) => e.key === 'Enter' && sendMessage());

      document.querySelectorAll('[data-source]').forEach(opt => {
        opt.addEventListener('click', () => {
          const source = opt.dataset.source;
          const cb = opt.querySelector('input');
          cb.checked = !cb.checked;

          if (source === 'all') {
            selectedSources = new Set(['all']);
            document.querySelectorAll('[data-source] input').forEach(c => c.checked = c.id === 'filter-all');
          } else {
            selectedSources.delete('all');
            cb.checked ? selectedSources.add(source) : selectedSources.delete(source);
            if (!selectedSources.size) selectedSources = new Set(['all']);
          }
          document.getElementById('filter-all').checked = selectedSources.has('all');
          displayFeedback();
        });
      });

      document.querySelectorAll('[data-sentiment]').forEach(opt => {
        opt.addEventListener('click', () => {
          const sentiment = opt.dataset.sentiment;
          const cb = opt.querySelector('input');
          cb.checked = !cb.checked;
          cb.checked ? selectedSentiments.add(sentiment) : selectedSentiments.delete(sentiment);
          displayFeedback();
        });
      });

      document.querySelectorAll('[data-urgency]').forEach(opt => {
        opt.addEventListener('click', () => {
          const urgency = opt.dataset.urgency;
          const cb = opt.querySelector('input');
          cb.checked = !cb.checked;
          cb.checked ? selectedUrgencies.add(urgency) : selectedUrgencies.delete(urgency);
          displayFeedback();
        });
      });

      // Sort select
      document.getElementById('sortSelect').addEventListener('change', (e) => {
        currentSort = e.target.value;
        displayFeedback();
      });

      document.querySelectorAll('.quick-action-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.getElementById('aiInput').value = btn.dataset.prompt;
          sendMessage();
        });
      });
    }

    function addMessage(type, text, isHtml = false) {
      const area = document.getElementById('messagesArea');
      const msg = document.createElement('div');
      msg.className = `message ${type}`;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      if (isHtml) {
        bubble.innerHTML = text;
      } else {
        bubble.textContent = text;
      }
      msg.appendChild(bubble);
      area.appendChild(msg);
      area.scrollTop = area.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById('aiInput');
      const query = input.value.trim();
      if (!query) return;

      addMessage('user', query);
      input.value = '';
      document.getElementById('quickActions').style.display = 'none';

      const lower = query.toLowerCase();

      // Check if this is a conversational message (not a PM/feedback query)
      const conversationalResponse = getConversationalResponse(lower, query);
      if (conversationalResponse) {
        await delay(300); // Brief pause for natural feel
        addMessage('ai', conversationalResponse, true);
        return;
      }

      // Check if this is a PM/feedback-related query
      if (isPMQuery(lower)) {
        await runPMAnalysis(query);
      } else {
        // Default: try to be helpful and guide to PM features
        await delay(300);
        addMessage('ai', `<div style="font-size: 13px;">
          <div style="margin-bottom: 10px;">I'm your PM companion for analyzing customer feedback. I'm not sure how to help with "<em>${escapeHtml(query)}</em>" specifically.</div>
          <div style="margin-bottom: 8px; color: #F38020;">Here's what I can help you with:</div>
          <div style="color: #ccc; margin-bottom: 6px;">• <strong>Analyze feedback</strong> — "What are my critical blockers?"</div>
          <div style="color: #ccc; margin-bottom: 6px;">• <strong>Find trends</strong> — "Show me negative feedback patterns"</div>
          <div style="color: #ccc; margin-bottom: 6px;">• <strong>Filter by source</strong> — "What's coming from Discord?"</div>
          <div style="color: #ccc; margin-bottom: 6px;">• <strong>Get insights</strong> — "Give me a feedback overview"</div>
          <div style="margin-top: 10px; font-size: 12px; color: #888;">Try asking one of these or use the quick actions below!</div>
        </div>`, true);
        document.getElementById('quickActions').style.display = 'flex';
      }
    }

    function getConversationalResponse(lower, original) {
      // Greetings
      if (/^(hi|hello|hey|howdy|hola|greetings|yo|sup)\b/.test(lower)) {
        return `<div style="font-size: 13px;">
          <div style="margin-bottom: 8px;">👋 Hey there! I'm your PM Feedback Assistant.</div>
          <div style="color: #ccc;">I help you analyze customer feedback from Discord, email, support tickets, Twitter, and GitHub. Ask me about trends, critical issues, sentiment, or specific sources!</div>
        </div>`;
      }

      // How are you / what's up
      if (/how are you|how('s| is) it going|what('s| is) up|how do you do/.test(lower)) {
        const stats = computeStats(allFeedback);
        return `<div style="font-size: 13px;">
          <div style="margin-bottom: 8px;">I'm doing great, thanks for asking! 🙂</div>
          <div style="color: #ccc; margin-bottom: 6px;">Currently monitoring <strong style="color: #F38020;">${stats.total}</strong> feedback items across ${stats.sources.length} sources.</div>
          <div style="color: #888; font-size: 12px;">Quick status: ${stats.critical} critical, ${stats.negative} negative, ${stats.positive} positive</div>
        </div>`;
      }

      // Thanks
      if (/^(thanks|thank you|thx|ty|appreciate|cheers)\b/.test(lower)) {
        return `<div style="font-size: 13px;">You're welcome! Let me know if you need more feedback insights. 👍</div>`;
      }

      // Help
      if (/^(help|what can you do|capabilities|commands)\b/.test(lower)) {
        return `<div style="font-size: 13px;">
          <div style="margin-bottom: 10px; color: #F38020; font-weight: 600;">What I can help you with:</div>
          <div style="color: #ccc; margin-bottom: 6px;">🚨 <strong>Critical Issues</strong> — "Show me urgent blockers"</div>
          <div style="color: #ccc; margin-bottom: 6px;">📉 <strong>Sentiment Analysis</strong> — "What's the negative feedback about?"</div>
          <div style="color: #ccc; margin-bottom: 6px;">📊 <strong>Overview</strong> — "Give me a feedback summary"</div>
          <div style="color: #ccc; margin-bottom: 6px;">💬 <strong>By Source</strong> — "What are Discord users saying?"</div>
          <div style="color: #ccc; margin-bottom: 6px;">✨ <strong>Feature Requests</strong> — "What features do customers want?"</div>
          <div style="margin-top: 10px; font-size: 12px; color: #888;">I use Cloudflare Workers AI to analyze patterns and generate insights!</div>
        </div>`;
      }

      // Who are you / about
      if (/who are you|what are you|about yourself|introduce/.test(lower)) {
        return `<div style="font-size: 13px;">
          <div style="margin-bottom: 8px;">I'm your <strong style="color: #F38020;">PM Feedback Intelligence Assistant</strong> 🤖</div>
          <div style="color: #ccc; margin-bottom: 6px;">Built on Cloudflare Workers, I help Product Managers like you make sense of customer feedback from multiple channels.</div>
          <div style="color: #888; font-size: 12px; margin-top: 8px;">Powered by: Workers • D1 Database • Workers AI (distilbert + llama-3.1)</div>
        </div>`;
      }

      // Bye
      if (/^(bye|goodbye|see you|later|cya)\b/.test(lower)) {
        return `<div style="font-size: 13px;">Goodbye! Come back anytime you need feedback insights. 👋</div>`;
      }

      return null; // Not a conversational message
    }

    function isPMQuery(lower) {
      const pmKeywords = [
        'feedback', 'critical', 'urgent', 'blocker', 'issue', 'bug', 'problem',
        'negative', 'positive', 'neutral', 'sentiment', 'trend', 'pattern',
        'overview', 'summary', 'analyze', 'analysis', 'insight', 'report',
        'feature', 'request', 'want', 'need', 'customer', 'user',
        'discord', 'email', 'support', 'ticket', 'twitter', 'github',
        'source', 'channel', 'complaint', 'praise', 'review',
        'priority', 'high', 'low', 'medium', 'show', 'find', 'get', 'list',
        'what', 'why', 'how many', 'which', 'where'
      ];
      return pmKeywords.some(kw => lower.includes(kw));
    }

    // Delay helper for animations
    const delay = ms => new Promise(r => setTimeout(r, ms));

    // Main PM Analysis function with multi-agent workflow visualization
    // Uses Workers AI backend with multiple specialized agents
    async function runPMAnalysis(query) {
      const lower = query.toLowerCase();
      const area = document.getElementById('messagesArea');

      // Create analysis container
      const analysisDiv = document.createElement('div');
      analysisDiv.className = 'message ai';
      analysisDiv.innerHTML = `<div class="bubble ai-analysis" id="currentAnalysis"></div>`;
      area.appendChild(analysisDiv);
      const container = document.getElementById('currentAnalysis');

      // Determine analysis type
      let analysisType = detectAnalysisType(lower);

      // Check if this might need web search
      const needsWebSearch = /latest|current|industry|benchmark|competitor|market|trend in|2024|2025|2026|best practice|strategy|how (do|should|can)/.test(lower);

      // Build the agent workflow HTML
      function buildAgentWorkflow(agents) {
        return `
          <div class="agent-workflow">
            <div class="agent-header">
              <span class="agent-system-badge">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                Multi-Agent System
              </span>
              <span class="agent-title">Cloudflare Workers AI</span>
            </div>
            <div class="agent-list">
              ${agents.map(a => `
                <div class="agent-item ${a.status}">
                  <div class="agent-icon">${a.icon}</div>
                  <div class="agent-details">
                    <div class="agent-name">${a.name}</div>
                    <div class="agent-status">${a.statusText}</div>
                    ${a.output ? `<div class="agent-output">${a.output.map(o => `<span class="agent-output-tag">${o}</span>`).join('')}</div>` : ''}
                  </div>
                </div>
              `).join('')}
            </div>
            ${needsWebSearch ? `
              <div class="web-search-indicator">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                Web Search Enabled — Can search for PM best practices and industry context
              </div>
            ` : ''}
          </div>
        `;
      }

      // Initial agent states
      const agents = [
        { name: 'Query Classifier Agent', icon: '🎯', status: 'active', statusText: 'Analyzing query intent...', output: null },
        { name: 'Data Retrieval Agent', icon: '📊', status: 'pending', statusText: 'Waiting...', output: null },
        { name: 'Sentiment Analysis Agent', icon: '🧠', status: 'pending', statusText: 'Waiting...', output: null },
        { name: 'PM Insight Agent (Llama 3.1)', icon: '💡', status: 'pending', statusText: 'Waiting...', output: null }
      ];

      container.innerHTML = buildAgentWorkflow(agents);
      area.scrollTop = area.scrollHeight;
      await delay(500);

      // Agent 1 complete
      agents[0].status = 'complete';
      agents[0].statusText = 'Intent classified';
      agents[0].output = [analysisType.label, needsWebSearch ? 'Web context needed' : 'Local analysis'];
      agents[1].status = 'active';
      agents[1].statusText = 'Querying Cloudflare D1...';
      container.innerHTML = buildAgentWorkflow(agents);
      area.scrollTop = area.scrollHeight;

      // Call the agent API
      let apiResponse = null;
      try {
        const response = await fetch('/api/agent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query }),
        });
        apiResponse = await response.json();
      } catch (err) {
        console.error('Agent API call failed:', err);
        // Fallback to analyze endpoint
        try {
          const response = await fetch('/api/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query }),
          });
          apiResponse = await response.json();
        } catch (e) {
          console.error('Fallback failed:', e);
        }
      }

      // Agent 2 complete
      const dataCount = apiResponse?.data?.count || apiResponse?.stats?.total || allFeedback.length;
      agents[1].status = 'complete';
      agents[1].statusText = 'Data retrieved from D1';
      agents[1].output = [`${dataCount} records`, `${apiResponse?.meta?.agentsUsed?.length || 4} agents`];
      agents[2].status = 'active';
      agents[2].statusText = 'Running distilbert-sst-2...';
      container.innerHTML = buildAgentWorkflow(agents);
      area.scrollTop = area.scrollHeight;
      await delay(400);

      // Agent 3 complete
      agents[2].status = 'complete';
      agents[2].statusText = 'Sentiment analyzed';
      agents[2].output = ['Positive', 'Negative', 'Neutral'];
      agents[3].status = 'active';
      agents[3].statusText = 'Generating insights with Llama 3.1...';
      container.innerHTML = buildAgentWorkflow(agents);
      area.scrollTop = area.scrollHeight;
      await delay(500);

      // Agent 4 complete
      agents[3].status = 'complete';
      agents[3].statusText = 'PM insights generated';
      agents[3].output = ['Summary', 'Recommendations', 'Actions'];
      container.innerHTML = buildAgentWorkflow(agents);
      area.scrollTop = area.scrollHeight;
      await delay(300);

      // Build final results
      const results = apiResponse?.data?.sample || apiResponse?.filtered?.items || analysisType.filter(allFeedback);
      const stats = apiResponse?.stats || computeStats(results);

      // Get AI response if available
      let aiTextResponse = apiResponse?.response || '';

      // Generate natural language response
      const naturalResponse = aiTextResponse
        ? `<div class="ai-response">
            <div class="ai-response-text">${escapeHtml(aiTextResponse)}</div>
          </div>`
        : generateNaturalResponse(query, results, stats, analysisType, apiResponse?.ai?.insights);

      // Build insights
      const insights = generatePMInsights(results, stats, analysisType, apiResponse?.ai?.insights);

      container.innerHTML = buildAgentWorkflow(agents) + naturalResponse + buildInsightsSection(insights, results, apiResponse?.ai?.insights);

      area.scrollTop = area.scrollHeight;
      container.removeAttribute('id');
    }

    function generateNaturalResponse(query, results, stats, analysisType, aiInsights) {
      const lower = query.toLowerCase();
      let response = '';

      // If we have AI-generated summary, use it
      if (aiInsights?.summary && !aiInsights.error) {
        response = `<div class="ai-response">
          <div class="ai-response-text">${escapeHtml(aiInsights.summary)}</div>
          ${aiInsights.recommendation ? `<div class="ai-response-recommendation">💡 <strong>Recommendation:</strong> ${escapeHtml(aiInsights.recommendation)}</div>` : ''}
        </div>`;
      } else {
        // Generate response based on query type and data
        const criticalCount = results.filter(r => r.urgency === 'critical').length;
        const highCount = results.filter(r => r.urgency === 'high').length;
        const negativeCount = results.filter(r => r.sentiment === 'negative').length;
        const positiveCount = results.filter(r => r.sentiment === 'positive').length;

        if (lower.includes('critical') || lower.includes('blocker') || lower.includes('urgent')) {
          if (criticalCount > 0 || highCount > 0) {
            response = `<div class="ai-response">
              <div class="ai-response-text">You have <strong style="color: #ef4444;">${criticalCount} critical</strong> and <strong style="color: #f97316;">${highCount} high-priority</strong> issues that need attention.</div>
              <div class="ai-response-detail">${criticalCount > 0 ? `The most urgent is: "${escapeHtml(results.find(r => r.urgency === 'critical')?.content.substring(0, 100) || '')}..."` : `Top high-priority: "${escapeHtml(results.find(r => r.urgency === 'high')?.content.substring(0, 100) || '')}..."`}</div>
              <div class="ai-response-recommendation">💡 <strong>Recommendation:</strong> Address critical items immediately - they're likely blocking users or causing revenue impact.</div>
            </div>`;
          } else {
            response = `<div class="ai-response">
              <div class="ai-response-text">Good news! You have <strong style="color: #22c55e;">no critical blockers</strong> at the moment.</div>
              <div class="ai-response-detail">Found ${results.length} items in your feedback, but none are marked as critical urgency.</div>
            </div>`;
          }
        } else if (lower.includes('negative') || lower.includes('complaint') || lower.includes('problem')) {
          response = `<div class="ai-response">
            <div class="ai-response-text">Found <strong style="color: #ef4444;">${negativeCount} negative feedback</strong> items out of ${stats.total} total.</div>
            ${negativeCount > 0 ? `<div class="ai-response-detail">Common themes include: ${getTopThemes(results.filter(r => r.sentiment === 'negative'))}</div>` : ''}
            <div class="ai-response-recommendation">💡 <strong>Recommendation:</strong> ${negativeCount > positiveCount ? 'Negative sentiment is high - consider a focused review session with the team.' : 'Negative feedback is manageable - address the top issues in your next sprint.'}</div>
          </div>`;
        } else if (lower.includes('positive') || lower.includes('happy') || lower.includes('praise')) {
          response = `<div class="ai-response">
            <div class="ai-response-text">You have <strong style="color: #22c55e;">${positiveCount} positive feedback</strong> items - ${Math.round((positiveCount / stats.total) * 100)}% of all feedback!</div>
            ${positiveCount > 0 ? `<div class="ai-response-detail">Customers are happy about: ${getTopThemes(results.filter(r => r.sentiment === 'positive'))}</div>` : ''}
            <div class="ai-response-recommendation">💡 <strong>Recommendation:</strong> Consider reaching out to these happy customers for testimonials or case studies.</div>
          </div>`;
        } else if (lower.includes('feature') || lower.includes('request') || lower.includes('want') || lower.includes('need')) {
          const featureRequests = results.filter(r => r.sentiment === 'neutral' || r.content.toLowerCase().includes('want') || r.content.toLowerCase().includes('need') || r.content.toLowerCase().includes('would'));
          response = `<div class="ai-response">
            <div class="ai-response-text">Found <strong style="color: #F38020;">${featureRequests.length} potential feature requests</strong> in your feedback.</div>
            <div class="ai-response-detail">Top requests: ${getTopThemes(featureRequests)}</div>
            <div class="ai-response-recommendation">💡 <strong>Recommendation:</strong> Group similar requests and prioritize by frequency and customer impact for your roadmap.</div>
          </div>`;
        } else if (lower.includes('overview') || lower.includes('summary') || lower.includes('trend')) {
          const sentiment = positiveCount > negativeCount ? 'positive' : negativeCount > positiveCount ? 'concerning' : 'balanced';
          response = `<div class="ai-response">
            <div class="ai-response-text">Here's your feedback overview: <strong>${stats.total} items</strong> across ${stats.sources.length} channels.</div>
            <div class="ai-response-detail">
              Sentiment breakdown: ${positiveCount} positive, ${stats.neutral} neutral, ${negativeCount} negative<br>
              Urgency: ${criticalCount} critical, ${highCount} high, ${stats.medium} medium, ${stats.low} low
            </div>
            <div class="ai-response-recommendation">💡 <strong>Overall:</strong> Sentiment is ${sentiment}. ${criticalCount > 0 ? `Prioritize the ${criticalCount} critical items first.` : 'No immediate blockers detected.'}</div>
          </div>`;
        } else if (lower.includes('discord') || lower.includes('email') || lower.includes('twitter') || lower.includes('github') || lower.includes('support')) {
          const sourceMatch = ['discord', 'email', 'twitter', 'github-issue', 'support-ticket'].find(s => lower.includes(s.replace('-', ' ').replace('-', '')));
          const sourceResults = results.filter(r => sourceMatch && r.source.includes(sourceMatch.split('-')[0]));
          response = `<div class="ai-response">
            <div class="ai-response-text">Found <strong style="color: #F38020;">${sourceResults.length} items</strong> from ${sourceMatch || 'that source'}.</div>
            <div class="ai-response-detail">Sentiment: ${sourceResults.filter(r => r.sentiment === 'positive').length} positive, ${sourceResults.filter(r => r.sentiment === 'negative').length} negative</div>
            <div class="ai-response-recommendation">💡 <strong>Insight:</strong> ${sourceResults.filter(r => r.sentiment === 'negative').length > sourceResults.filter(r => r.sentiment === 'positive').length ? 'This channel has more complaints than praise - may need attention.' : 'This channel has healthy sentiment overall.'}</div>
          </div>`;
        } else {
          // Generic response
          response = `<div class="ai-response">
            <div class="ai-response-text">Analyzed <strong>${results.length} relevant items</strong> from your feedback.</div>
            <div class="ai-response-detail">Found ${negativeCount} negative, ${positiveCount} positive, and ${criticalCount + highCount} high-priority items.</div>
            ${criticalCount > 0 ? `<div class="ai-response-recommendation">💡 <strong>Note:</strong> You have ${criticalCount} critical items that may need immediate attention.</div>` : ''}
          </div>`;
        }
      }

      return response;
    }

    function getTopThemes(items) {
      if (!items.length) return 'No specific themes detected';
      // Extract key phrases from content
      const phrases = items.slice(0, 3).map(item => {
        const content = item.content.toLowerCase();
        // Find key phrases
        if (content.includes('login')) return 'login/authentication';
        if (content.includes('performance') || content.includes('slow')) return 'performance issues';
        if (content.includes('mobile') || content.includes('app')) return 'mobile app';
        if (content.includes('dashboard')) return 'dashboard';
        if (content.includes('api') || content.includes('docs')) return 'API/documentation';
        if (content.includes('price') || content.includes('billing')) return 'pricing/billing';
        if (content.includes('support')) return 'customer support';
        if (content.includes('dark mode')) return 'dark mode';
        if (content.includes('integration') || content.includes('slack') || content.includes('zapier')) return 'integrations';
        return item.content.substring(0, 30) + '...';
      });
      return [...new Set(phrases)].slice(0, 3).join(', ');
    }

    function detectAnalysisType(query) {
      if (query.includes('critical') || query.includes('urgent') || query.includes('priority') || query.includes('blockers')) {
        return { label: 'Critical Issues Analysis', filter: f => f.urgency === 'critical' || f.urgency === 'high' || f.sentiment === 'negative' };
      }
      if (query.includes('negative') || query.includes('complaint') || query.includes('unhappy') || query.includes('problems')) {
        return { label: 'Negative Sentiment Analysis', filter: f => f.sentiment === 'negative' };
      }
      if (query.includes('positive') || query.includes('happy') || query.includes('praise') || query.includes('good')) {
        return { label: 'Positive Feedback Analysis', filter: f => f.sentiment === 'positive' };
      }
      if (query.includes('trend') || query.includes('pattern') || query.includes('overview') || query.includes('summary')) {
        return { label: 'Trend Analysis', filter: f => true };
      }
      if (query.includes('feature') || query.includes('request') || query.includes('want') || query.includes('need')) {
        return { label: 'Feature Request Analysis', filter: f => f.sentiment === 'neutral' || f.content.toLowerCase().includes('want') || f.content.toLowerCase().includes('need') };
      }
      if (query.includes('discord')) return { label: 'Discord Channel Analysis', filter: f => f.source === 'discord' };
      if (query.includes('email')) return { label: 'Email Feedback Analysis', filter: f => f.source === 'email' };
      if (query.includes('support') || query.includes('ticket')) return { label: 'Support Ticket Analysis', filter: f => f.source === 'support-ticket' };
      if (query.includes('twitter') || query.includes('social')) return { label: 'Social Media Analysis', filter: f => f.source === 'twitter' };
      if (query.includes('github') || query.includes('issue')) return { label: 'GitHub Issues Analysis', filter: f => f.source === 'github-issue' };
      return { label: 'General Feedback Analysis', filter: f => true };
    }

    function computeStats(results) {
      return {
        total: results.length,
        positive: results.filter(f => f.sentiment === 'positive').length,
        negative: results.filter(f => f.sentiment === 'negative').length,
        neutral: results.filter(f => f.sentiment === 'neutral').length,
        critical: results.filter(f => f.urgency === 'critical').length,
        high: results.filter(f => f.urgency === 'high').length,
        medium: results.filter(f => f.urgency === 'medium').length,
        low: results.filter(f => f.urgency === 'low').length,
        sources: [...new Set(results.map(r => r.source))]
      };
    }

    function generatePMInsights(results, stats, analysisType, aiInsights) {
      const insights = [];

      // If we have AI-generated insights from Workers AI, prioritize those
      if (aiInsights && !aiInsights.error) {
        // AI Summary
        if (aiInsights.summary) {
          insights.push({
            type: 'ai-summary',
            title: 'AI Analysis Summary',
            content: aiInsights.summary,
            aiGenerated: true
          });
        }

        // AI-detected critical count
        if (aiInsights.critical_count > 0) {
          insights.push({
            type: 'ai-critical',
            title: 'Critical Issues Detected',
            count: aiInsights.critical_count,
            aiGenerated: true
          });
        }

        // AI Recommendation
        if (aiInsights.recommendation) {
          insights.push({
            type: 'ai-recommendation',
            title: 'AI Recommendation',
            content: aiInsights.recommendation,
            aiGenerated: true
          });
        }

        // Sentiment Trend
        if (aiInsights.sentiment_trend) {
          insights.push({
            type: 'ai-trend',
            title: 'Sentiment Trend',
            trend: aiInsights.sentiment_trend,
            aiGenerated: true
          });
        }
      }

      // Key Metric (always include)
      if (stats.total > 0) {
        const negPercent = Math.round((stats.negative / stats.total) * 100);
        const critPercent = Math.round(((stats.critical + stats.high) / stats.total) * 100);

        insights.push({
          type: 'metric',
          title: 'Key Metrics',
          content: `${stats.total} items analyzed • ${negPercent}% negative sentiment • ${critPercent}% high-priority`
        });
      }

      // Critical Action Items
      const criticalItems = results.filter(f => f.urgency === 'critical' || (f.urgency === 'high' && f.sentiment === 'negative'));
      if (criticalItems.length > 0) {
        insights.push({
          type: 'action',
          title: 'Requires Immediate Attention',
          priority: 'p1',
          content: criticalItems[0].content,
          source: criticalItems[0].source
        });
      }

      // High Priority
      const highItems = results.filter(f => f.urgency === 'high' && f.sentiment !== 'positive');
      if (highItems.length > 1) {
        insights.push({
          type: 'action',
          title: 'High Priority Items',
          priority: 'p2',
          content: `${highItems.length} items need attention this week`,
          items: highItems.slice(0, 2)
        });
      }

      // Recommendation (only if no AI recommendation)
      if (!aiInsights?.recommendation) {
        if (stats.negative > stats.positive) {
          insights.push({
            type: 'recommendation',
            title: 'PM Recommendation',
            content: `Negative feedback (${stats.negative}) outweighs positive (${stats.positive}). Consider scheduling a customer feedback review to identify root causes.`
          });
        } else if (stats.positive > stats.negative * 2) {
          insights.push({
            type: 'recommendation',
            title: 'PM Recommendation',
            content: `Strong positive sentiment! Consider reaching out to happy customers for testimonials or case studies.`
          });
        }
      }

      // Source Distribution
      if (stats.sources.length > 1) {
        const sourceCounts = stats.sources.map(s => ({
          source: s,
          count: results.filter(r => r.source === s).length
        })).sort((a, b) => b.count - a.count);

        insights.push({
          type: 'distribution',
          title: 'Feedback Sources',
          sources: sourceCounts
        });
      }

      return insights;
    }

    function buildStep(num, status, title, chips, progress) {
      const chipsHtml = chips.map(c => `<span class="ai-chip ${c.status}">${c.status === 'active' ? '◉' : '✓'} ${c.text}</span>`).join('');
      return `
        <div class="ai-step ${status === 'pending' ? 'pending' : ''}">
          <div class="ai-step-num ${status}">${status === 'done' ? '✓' : num}</div>
          <div class="ai-step-content">
            <div class="ai-step-title">${title}</div>
            <div class="ai-chips">${chipsHtml}</div>
          </div>
        </div>
        ${progress ? `<div class="ai-progress"><div class="ai-progress-bar" style="width: ${progress}%"></div></div>` : ''}
      `;
    }

    function buildInsightsSection(insights, results, aiInsights) {
      let html = '<div class="insights-container">';

      // AI-powered insights section (if available)
      const aiPoweredInsights = insights.filter(i => i.aiGenerated);
      const standardInsights = insights.filter(i => !i.aiGenerated);

      if (aiPoweredInsights.length > 0) {
        html += '<div class="ai-powered-section">';
        html += '<div class="ai-powered-header"><span class="ai-badge">Workers AI</span> Intelligent Analysis</div>';

        aiPoweredInsights.forEach(insight => {
          if (insight.type === 'ai-summary') {
            html += `<div class="ai-insight ai-generated">
              <div class="ai-insight-label">🤖 ${insight.title}</div>
              <div class="ai-insight-text">${escapeHtml(insight.content)}</div>
            </div>`;
          } else if (insight.type === 'ai-critical') {
            html += `<div class="ai-insight ai-generated" style="border-left-color: #ef4444;">
              <div class="ai-insight-label" style="color: #ef4444;">🚨 ${insight.title}</div>
              <div class="ai-insight-text">${insight.count} critical issue${insight.count > 1 ? 's' : ''} identified by AI analysis</div>
            </div>`;
          } else if (insight.type === 'ai-recommendation') {
            html += `<div class="ai-insight ai-generated" style="border-left-color: #22c55e;">
              <div class="ai-insight-label" style="color: #22c55e;">💡 ${insight.title}</div>
              <div class="ai-insight-text">${escapeHtml(insight.content)}</div>
            </div>`;
          } else if (insight.type === 'ai-trend') {
            const trendIcon = insight.trend === 'improving' ? '📈' : insight.trend === 'declining' ? '📉' : '➡️';
            const trendColor = insight.trend === 'improving' ? '#22c55e' : insight.trend === 'declining' ? '#ef4444' : '#F38020';
            html += `<div class="ai-insight ai-generated" style="border-left-color: ${trendColor};">
              <div class="ai-insight-label" style="color: ${trendColor};">${trendIcon} ${insight.title}</div>
              <div class="ai-insight-text">Sentiment is <strong style="color: ${trendColor};">${insight.trend}</strong></div>
            </div>`;
          }
        });

        html += '</div>';
      }

      // Standard insights
      standardInsights.forEach(insight => {
        if (insight.type === 'metric') {
          html += `<div class="ai-insight">
            <div class="ai-insight-label">📊 ${insight.title}</div>
            <div class="ai-insight-text">${insight.content}</div>
          </div>`;
        } else if (insight.type === 'action') {
          html += `<div class="ai-action">
            <span class="ai-priority ${insight.priority}">${insight.priority === 'p1' ? 'Critical' : 'High'}</span>
            <div>
              <div style="font-size: 11px; color: #F38020; margin-bottom: 2px;">${insight.title}</div>
              <div class="ai-action-text">"${escapeHtml(insight.content)}"</div>
              ${insight.source ? `<div style="font-size: 10px; color: #666; margin-top: 4px;">Source: ${insight.source}</div>` : ''}
            </div>
          </div>`;
        } else if (insight.type === 'recommendation') {
          html += `<div class="ai-insight" style="border-left-color: #22c55e;">
            <div class="ai-insight-label" style="color: #22c55e;">💡 ${insight.title}</div>
            <div class="ai-insight-text">${insight.content}</div>
          </div>`;
        } else if (insight.type === 'distribution') {
          // Create expandable source sections with actual feedback messages
          const sourceAccordions = insight.sources.map(s => {
            const sourceItems = results.filter(r => r.source === s.source).slice(0, 5);
            const itemsHtml = sourceItems.map(item => {
              const sColor = item.sentiment === 'positive' ? '#22c55e' : item.sentiment === 'negative' ? '#ef4444' : '#888';
              return `<div class="source-message-item">
                <div class="source-message-meta" style="color: ${sColor};">${item.sentiment} • ${item.urgency}</div>
                <div class="source-message-text">"${escapeHtml(item.content)}"</div>
                ${item.author ? `<div class="source-message-author">— ${escapeHtml(item.author)}</div>` : ''}
              </div>`;
            }).join('');

            return `<div class="source-accordion">
              <button class="source-accordion-btn" onclick="this.parentElement.classList.toggle('expanded')">
                <span>${getSourceIcon(s.source)} ${s.source}</span>
                <span class="source-count">${s.count} items</span>
                <span class="accordion-arrow">▶</span>
              </button>
              <div class="source-accordion-content">
                ${itemsHtml}
                ${sourceItems.length < s.count ? `<div class="source-more">+ ${s.count - sourceItems.length} more items</div>` : ''}
              </div>
            </div>`;
          }).join('');

          html += `<div class="ai-sources-expandable">
            <div class="ai-sources-label">📍 Feedback by Source <span style="font-weight: 400; color: #666;">(click to expand)</span></div>
            ${sourceAccordions}
          </div>`;
        }
      });

      // Top results preview (only if no distribution insight)
      const hasDistribution = standardInsights.some(i => i.type === 'distribution');
      if (results.length > 0 && !hasDistribution) {
        html += `<div class="results-preview">
          <div class="results-preview-header">Top Results Preview</div>`;
        results.slice(0, 3).forEach(item => {
          const sColor = item.sentiment === 'positive' ? '#22c55e' : item.sentiment === 'negative' ? '#ef4444' : '#888';
          html += `<div class="results-preview-item">
            <div style="color: ${sColor}; font-size: 10px; margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">${getSourceIcon(item.source)} ${item.source} • ${item.sentiment} • ${item.urgency}</div>
            <div style="color: #ccc;">"${escapeHtml(item.content.substring(0, 100))}${item.content.length > 100 ? '...' : ''}"</div>
          </div>`;
        });
        html += '</div>';
      }

      html += '</div>';
      return html;
    }

    function escapeHtml(text) {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
