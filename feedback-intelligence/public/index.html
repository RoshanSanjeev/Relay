<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Feedback Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f0f0f;
      color: #e5e5e5;
      line-height: 1.6;
      letter-spacing: -0.3px;
      overflow: hidden;
    }

    /* Premium gradient background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #0d0d0d 100%);
      z-index: -1;
      pointer-events: none;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: rgba(15, 15, 15, 0.5);
      position: relative;
    }

    /* ========== HEADER ========== */
    header {
      background: rgba(10, 10, 10, 0.6);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(243, 128, 32, 0.1);
      padding: 20px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(to right, transparent, #F38020, transparent);
      opacity: 0.3;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-brand h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 32px;
      font-weight: 700;
      color: #F38020;
      letter-spacing: -1px;
      line-height: 1;
    }

    .header-brand p {
      font-size: 12px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1.2px;
    }

    .header-controls {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .mock-data-badge {
      background: rgba(243, 128, 32, 0.08);
      border: 1px solid rgba(243, 128, 32, 0.25);
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      color: #F38020;
      font-weight: 600;
      letter-spacing: 0.3px;
      display: flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(10px);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .mock-data-badge:hover {
      border-color: rgba(243, 128, 32, 0.5);
      background: rgba(243, 128, 32, 0.12);
    }

    .button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.3px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
    }

    .button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.1);
      transition: left 0.3s ease;
      z-index: -1;
    }

    .button:hover::before {
      left: 100%;
    }

    .button.primary {
      background: #F38020;
      color: #000;
      box-shadow: 0 8px 24px rgba(243, 128, 32, 0.2);
    }

    .button.primary:hover {
      box-shadow: 0 12px 32px rgba(243, 128, 32, 0.3);
      transform: translateY(-2px);
    }

    .button.secondary {
      background: rgba(255, 255, 255, 0.08);
      color: #e5e5e5;
      border: 1px solid rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
    }

    .button.secondary:hover {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(255, 255, 255, 0.25);
    }

    /* ========== CONTENT ========== */
    .content {
      display: flex;
      flex: 1;
      overflow: hidden;
      gap: 0;
    }

    /* ========== DRAGGABLE DIVIDER ========== */
    .divider {
      width: 6px;
      background: rgba(243, 128, 32, 0.1);
      cursor: col-resize;
      transition: background-color 0.2s ease;
      position: relative;
      flex-shrink: 0;
    }

    .divider:hover {
      background: rgba(243, 128, 32, 0.3);
    }

    .divider.dragging {
      background: rgba(243, 128, 32, 0.5);
    }

    /* ========== LEFT PANEL - AI CHAT ========== */
    .left-panel {
      flex: 0 0 48%;
      display: flex;
      flex-direction: column;
      background: rgba(20, 20, 20, 0.4);
      position: relative;
      min-width: 300px;
    }

    .left-panel::after {
      content: '';
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 1px;
      background: linear-gradient(to bottom, transparent, rgba(243, 128, 32, 0.2), transparent);
      pointer-events: none;
    }

    .panel-header {
      padding: 28px 28px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      background: linear-gradient(to bottom, rgba(30, 30, 30, 0.8), rgba(20, 20, 20, 0.4));
    }

    .panel-header h2 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 28px;
      font-weight: 600;
      color: #fff;
      letter-spacing: -0.5px;
      margin-bottom: 6px;
    }

    .panel-header p {
      font-size: 12px;
      color: #777;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      font-weight: 500;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px 28px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .chat-container::-webkit-scrollbar {
      width: 8px;
    }

    .chat-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-container::-webkit-scrollbar-thumb {
      background: rgba(243, 128, 32, 0.2);
      border-radius: 4px;
    }

    .chat-container::-webkit-scrollbar-thumb:hover {
      background: rgba(243, 128, 32, 0.4);
    }

    .messages-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 24px;
    }

    .message {
      display: flex;
      gap: 12px;
      animation: slideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      justify-content: flex-end;
    }

    .bubble {
      max-width: 85%;
      padding: 14px 18px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .message.ai .bubble {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #d5d5d5;
      backdrop-filter: blur(10px);
    }

    .message.user .bubble {
      background: #F38020;
      color: #000;
      font-weight: 500;
      letter-spacing: 0.2px;
      box-shadow: 0 4px 16px rgba(243, 128, 32, 0.2);
    }

    .quick-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .quick-action-label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    .quick-action-btn {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(243, 128, 32, 0.15);
      color: #d5d5d5;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
      font-weight: 500;
    }

    .quick-action-btn:hover {
      background: rgba(243, 128, 32, 0.1);
      border-color: rgba(243, 128, 32, 0.35);
      transform: translateX(4px);
    }

    .input-area {
      padding: 20px 28px 28px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      gap: 12px;
    }

    .input-wrapper {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-wrapper input {
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #fff;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-family: 'Inter', sans-serif;
      transition: all 0.3s ease;
      outline: none;
    }

    .input-wrapper input::placeholder {
      color: #666;
    }

    .input-wrapper input:focus {
      border-color: rgba(243, 128, 32, 0.4);
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 20px rgba(243, 128, 32, 0.1);
    }

    /* ========== RIGHT PANEL - BROWSER ========== */
    .right-panel {
      flex: 0 0 52%;
      display: flex;
      flex-direction: column;
      background: rgba(15, 15, 15, 0.3);
      position: relative;
      min-width: 300px;
    }

    .filters-container {
      padding: 28px 28px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      background: linear-gradient(to bottom, rgba(30, 30, 30, 0.5), rgba(20, 20, 20, 0.2));
      max-height: 280px;
      overflow-y: auto;
    }

    .filters-container::-webkit-scrollbar {
      width: 6px;
    }

    .filters-container::-webkit-scrollbar-thumb {
      background: rgba(243, 128, 32, 0.2);
      border-radius: 3px;
    }

    .filter-section {
      margin-bottom: 24px;
    }

    .filter-section:last-child {
      margin-bottom: 0;
    }

    .filter-label {
      font-size: 11px;
      color: #F38020;
      text-transform: uppercase;
      letter-spacing: 1.1px;
      font-weight: 700;
      margin-bottom: 12px;
      display: block;
    }

    .filter-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 11px 14px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 7px;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .filter-option:hover {
      background: rgba(243, 128, 32, 0.08);
      border-color: rgba(243, 128, 32, 0.25);
      transform: translateX(3px);
    }

    .filter-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: #F38020;
    }

    .filter-option label {
      flex: 1;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .filter-count {
      font-size: 12px;
      color: #888;
      font-weight: 500;
    }

    .results-container {
      flex: 1;
      overflow-y: auto;
      padding: 24px 28px;
    }

    .results-container::-webkit-scrollbar {
      width: 8px;
    }

    .results-container::-webkit-scrollbar-thumb {
      background: rgba(243, 128, 32, 0.2);
      border-radius: 4px;
    }

    .results-header {
      font-family: 'Cormorant Garamond', serif;
      font-size: 16px;
      font-weight: 600;
      color: #F38020;
      margin-bottom: 16px;
      letter-spacing: -0.3px;
    }

    .feedback-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .feedback-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
    }

    .feedback-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: #F38020;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .feedback-item:hover {
      background: rgba(243, 128, 32, 0.08);
      border-color: rgba(243, 128, 32, 0.3);
      transform: translateX(4px);
    }

    .feedback-item:hover::before {
      opacity: 1;
    }

    .feedback-source {
      font-size: 11px;
      color: #F38020;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .feedback-text {
      font-size: 13px;
      color: #d5d5d5;
      line-height: 1.5;
      margin-bottom: 10px;
    }

    .feedback-meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.08);
      color: #aaa;
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-weight: 500;
    }

    .badge.sentiment-positive {
      background: rgba(34, 197, 94, 0.12);
      color: #22c55e;
      border-color: rgba(34, 197, 94, 0.25);
    }

    .badge.sentiment-negative {
      background: rgba(239, 68, 68, 0.12);
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.25);
    }

    .badge.urgency-critical {
      background: rgba(220, 38, 38, 0.15);
      color: #dc2626;
      border-color: rgba(220, 38, 38, 0.3);
      font-weight: 600;
    }

    .badge.urgency-high {
      background: rgba(249, 115, 22, 0.15);
      color: #f97316;
      border-color: rgba(249, 115, 22, 0.3);
    }

    .badge.urgency-medium {
      background: rgba(234, 179, 8, 0.15);
      color: #eab308;
      border-color: rgba(234, 179, 8, 0.3);
    }

    .badge.urgency-low {
      background: rgba(34, 197, 94, 0.12);
      color: #22c55e;
      border-color: rgba(34, 197, 94, 0.25);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    /* ========== LOADING ========== */
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(243, 128, 32, 0.2);
      border-top-color: #F38020;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 1200px) {
      .left-panel {
        flex: 0 0 45%;
      }
      .right-panel {
        flex: 0 0 55%;
      }
    }

    @media (max-width: 768px) {
      .content {
        flex-direction: column;
      }

      .left-panel {
        flex: 0 0 50%;
        border-right: none;
        border-bottom: 1px solid rgba(243, 128, 32, 0.08);
      }

      .right-panel {
        flex: 0 0 50%;
      }
    }
  </style>
</head>

<body>
  <div class="app-container">
    <!-- HEADER -->
    <header>
      <div class="header-brand">
        <h1>Feedback Intelligence</h1>
        <p>AI-Powered Insights</p>
      </div>
      <div class="header-controls">
        <div class="mock-data-badge">
          <span>üìä</span>
          <span id="mockDataCount">0 items</span>
        </div>
        <button class="button secondary" id="generateMockBtn">Generate Mock Data</button>
        <button class="button primary" id="processAiBtn">Process with AI</button>
      </div>
    </header>

    <!-- CONTENT -->
    <div class="content" id="content">
      <!-- LEFT PANEL -->
      <div class="left-panel" id="leftPanel">
        <div class="panel-header">
          <h2>AI Assistant</h2>
          <p>Ask Questions About Your Feedback</p>
        </div>

        <div class="chat-container">
          <div class="messages-area" id="messagesArea"></div>

          <div class="quick-actions" id="quickActions">
            <div class="quick-action-label">Quick Actions</div>
            <button class="quick-action-btn" data-prompt="What are my critical feedback items?">üî¥ Critical Issues</button>
            <button class="quick-action-btn" data-prompt="Show me negative feedback">üò† Negative Feedback</button>
            <button class="quick-action-btn" data-prompt="What's coming from Discord?">üí¨ Discord Messages</button>
            <button class="quick-action-btn" data-prompt="Summarize support tickets">üé´ Support Summary</button>
          </div>
        </div>

        <div class="input-area">
          <div class="input-wrapper">
            <input type="text" id="aiInput" placeholder="Ask about your feedback..." />
          </div>
          <button class="button primary" id="sendBtn" style="padding: 12px 20px;">Send</button>
        </div>
      </div>

      <!-- DRAGGABLE DIVIDER -->
      <div class="divider" id="divider"></div>

      <!-- RIGHT PANEL -->
      <div class="right-panel" id="rightPanel">
        <div class="panel-header">
          <h2>Browse Feedback</h2>
          <p>Filter by Source & Sentiment</p>
        </div>

        <div class="filters-container">
          <div class="filter-section">
            <label class="filter-label">Source</label>
            <div class="filter-options">
              <div class="filter-option active" data-source="all">
                <input type="checkbox" id="filter-all" checked />
                <label for="filter-all">
                  <span>All Sources</span>
                </label>
              </div>
              <div class="filter-option" data-source="email">
                <input type="checkbox" id="filter-email" />
                <label for="filter-email">
                  <span>üìß Email</span>
                  <span class="filter-count" id="count-email">0</span>
                </label>
              </div>
              <div class="filter-option" data-source="discord">
                <input type="checkbox" id="filter-discord" />
                <label for="filter-discord">
                  <span>üí¨ Discord</span>
                  <span class="filter-count" id="count-discord">0</span>
                </label>
              </div>
              <div class="filter-option" data-source="support-ticket">
                <input type="checkbox" id="filter-support" />
                <label for="filter-support">
                  <span>üé´ Support</span>
                  <span class="filter-count" id="count-support">0</span>
                </label>
              </div>
              <div class="filter-option" data-source="twitter">
                <input type="checkbox" id="filter-twitter" />
                <label for="filter-twitter">
                  <span>ùïè Twitter</span>
                  <span class="filter-count" id="count-twitter">0</span>
                </label>
              </div>
              <div class="filter-option" data-source="github-issue">
                <input type="checkbox" id="filter-github" />
                <label for="filter-github">
                  <span>üêô GitHub</span>
                  <span class="filter-count" id="count-github">0</span>
                </label>
              </div>
            </div>
          </div>

          <div class="filter-section">
            <label class="filter-label">Sentiment</label>
            <div class="filter-options">
              <div class="filter-option" data-sentiment="positive">
                <input type="checkbox" id="filter-positive" />
                <label for="filter-positive">
                  <span>üòä Positive</span>
                  <span class="filter-count" id="count-positive">0</span>
                </label>
              </div>
              <div class="filter-option" data-sentiment="neutral">
                <input type="checkbox" id="filter-neutral" />
                <label for="filter-neutral">
                  <span>üòê Neutral</span>
                  <span class="filter-count" id="count-neutral">0</span>
                </label>
              </div>
              <div class="filter-option" data-sentiment="negative">
                <input type="checkbox" id="filter-negative" />
                <label for="filter-negative">
                  <span>üò† Negative</span>
                  <span class="filter-count" id="count-negative">0</span>
                </label>
              </div>
            </div>
          </div>

          <div class="filter-section">
            <label class="filter-label">Urgency</label>
            <div class="filter-options">
              <div class="filter-option" data-urgency="critical">
                <input type="checkbox" id="filter-critical" />
                <label for="filter-critical">
                  <span>üî¥ Critical</span>
                  <span class="filter-count" id="count-critical">0</span>
                </label>
              </div>
              <div class="filter-option" data-urgency="high">
                <input type="checkbox" id="filter-high" />
                <label for="filter-high">
                  <span>üü† High</span>
                  <span class="filter-count" id="count-high">0</span>
                </label>
              </div>
              <div class="filter-option" data-urgency="medium">
                <input type="checkbox" id="filter-medium" />
                <label for="filter-medium">
                  <span>üü° Medium</span>
                  <span class="filter-count" id="count-medium">0</span>
                </label>
              </div>
              <div class="filter-option" data-urgency="low">
                <input type="checkbox" id="filter-low" />
                <label for="filter-low">
                  <span>üü¢ Low</span>
                  <span class="filter-count" id="count-low">0</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="results-container">
          <div class="results-header" id="resultsHeader">All Feedback</div>
          <div class="feedback-list" id="feedbackList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const mockFeedback = [
      { content: 'Login completely broken, blocking all user access', source: 'support-ticket', sentiment: 'negative', urgency: 'critical', author: 'Support' },
      { content: 'New dashboard design is amazing, very intuitive', source: 'discord', sentiment: 'positive', urgency: 'low', author: 'User #234' },
      { content: 'API docs are outdated and missing examples', source: 'github-issue', sentiment: 'negative', urgency: 'high', author: 'Dev' },
      { content: 'Excellent customer support response time', source: 'email', sentiment: 'positive', urgency: 'low', author: 'Client' },
      { content: 'Performance is slow during peak hours', source: 'twitter', sentiment: 'negative', urgency: 'high', author: '@feedback' },
      { content: 'Would love dark mode support', source: 'discord', sentiment: 'neutral', urgency: 'medium', author: 'User #567' },
      { content: 'Slack integration would be powerful', source: 'github-issue', sentiment: 'positive', urgency: 'medium', author: 'Engineer' },
      { content: 'Pricing is higher than competitors', source: 'email', sentiment: 'negative', urgency: 'medium', author: 'Prospect' },
      { content: 'Works well for our enterprise needs', source: 'support-ticket', sentiment: 'positive', urgency: 'low', author: 'PM' },
      { content: 'Mobile app crashes on startup', source: 'twitter', sentiment: 'negative', urgency: 'critical', author: '@user' },
    ];

    let allFeedback = [];
    let selectedSources = new Set(['all']);
    let selectedSentiments = new Set();
    let selectedUrgencies = new Set();

    /* ========== DRAGGABLE DIVIDER ========== */
    let isDragging = false;
    const divider = document.getElementById('divider');
    const content = document.getElementById('content');
    const leftPanel = document.getElementById('leftPanel');
    const rightPanel = document.getElementById('rightPanel');

    divider.addEventListener('mousedown', () => {
      isDragging = true;
      divider.classList.add('dragging');
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;

      const contentRect = content.getBoundingClientRect();
      const newLeftWidth = e.clientX - contentRect.left;
      const totalWidth = contentRect.width;

      // Constrain to minimum widths
      if (newLeftWidth < 300 || totalWidth - newLeftWidth < 300) return;

      const leftPercent = (newLeftWidth / totalWidth) * 100;
      const rightPercent = 100 - leftPercent - 0.5; // 0.5% for divider

      leftPanel.style.flex = `0 0 ${leftPercent}%`;
      rightPanel.style.flex = `0 0 ${rightPercent}%`;
    });

    document.addEventListener('mouseup', () => {
      if (isDragging) {
        isDragging = false;
        divider.classList.remove('dragging');
        document.body.style.cursor = 'default';
        document.body.style.userSelect = 'auto';
      }
    });

    async function init() {
      await loadFeedback();
      updateCounts();
      displayFeedback();
      setupEventListeners();
      addMessage('ai', 'Welcome! Ask me about your feedback. Try "What are my critical issues?" or "Show negative feedback"');
    }

    async function loadFeedback() {
      try {
        const response = await fetch('/api/feedback?limit=1000');
        const data = await response.json();
        allFeedback = data.data || [];
        updateMockDataCount();
      } catch (error) {
        console.error('Failed to load:', error);
      }
    }

    function updateMockDataCount() {
      document.getElementById('mockDataCount').textContent = `${allFeedback.length} items`;
    }

    async function generateMockData() {
      const btn = document.getElementById('generateMockBtn');
      btn.disabled = true;
      btn.textContent = 'Generating...';

      try {
        for (const fb of mockFeedback) {
          await fetch('/api/feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(fb),
          });
        }
        await loadFeedback();
        displayFeedback();
      } finally {
        btn.disabled = false;
        btn.textContent = 'Generate Mock Data';
      }
    }

    function updateCounts() {
      const counts = { email: 0, discord: 0, 'support-ticket': 0, twitter: 0, 'github-issue': 0, positive: 0, neutral: 0, negative: 0, critical: 0, high: 0, medium: 0, low: 0 };
      allFeedback.forEach(item => {
        if (counts[item.source] !== undefined) counts[item.source]++;
        if (counts[item.sentiment] !== undefined) counts[item.sentiment]++;
        if (counts[item.urgency] !== undefined) counts[item.urgency]++;
      });
      Object.entries(counts).forEach(([key, count]) => {
        const el = document.getElementById(`count-${key}`);
        if (el) el.textContent = count;
      });
    }

    function displayFeedback() {
      const sources = selectedSources.has('all') ? null : Array.from(selectedSources);
      const sentiments = selectedSentiments.size > 0 ? Array.from(selectedSentiments) : null;
      const urgencies = selectedUrgencies.size > 0 ? Array.from(selectedUrgencies) : null;

      let filtered = allFeedback.filter(item => {
        const sourceMatch = !sources || sources.includes(item.source);
        const sentimentMatch = !sentiments || sentiments.includes(item.sentiment);
        const urgencyMatch = !urgencies || urgencies.includes(item.urgency);
        return sourceMatch && sentimentMatch && urgencyMatch;
      });

      const list = document.getElementById('feedbackList');
      const header = document.getElementById('resultsHeader');

      if (filtered.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No results</p></div>';
        header.textContent = 'No feedback found';
        return;
      }

      header.textContent = `Showing ${filtered.length} result${filtered.length !== 1 ? 's' : ''}`;
      list.innerHTML = filtered.map(item => `
        <div class="feedback-item">
          <div class="feedback-source">${getEmoji(item.source)} ${item.source}</div>
          <div class="feedback-text">${escapeHtml(item.content)}</div>
          <div class="feedback-meta">
            <span class="badge sentiment-${item.sentiment}">${item.sentiment}</span>
            <span class="badge urgency-${item.urgency}">‚ö° ${item.urgency}</span>
            ${item.author ? `<span class="badge">üë§ ${item.author}</span>` : ''}
          </div>
        </div>
      `).join('');
    }

    function getEmoji(source) {
      return { email: 'üìß', discord: 'üí¨', 'support-ticket': 'üé´', twitter: 'ùïè', 'github-issue': 'üêô' }[source] || 'üìù';
    }

    function setupEventListeners() {
      document.getElementById('generateMockBtn').addEventListener('click', generateMockData);
      document.getElementById('processAiBtn').addEventListener('click', () => addMessage('ai', '‚ö° Processing feedback with AI...'));
      document.getElementById('sendBtn').addEventListener('click', sendMessage);
      document.getElementById('aiInput').addEventListener('keypress', (e) => e.key === 'Enter' && sendMessage());

      document.querySelectorAll('[data-source]').forEach(opt => {
        opt.addEventListener('click', () => {
          const source = opt.dataset.source;
          const cb = opt.querySelector('input');
          cb.checked = !cb.checked;

          if (source === 'all') {
            selectedSources = new Set(['all']);
            document.querySelectorAll('[data-source] input').forEach(c => c.checked = c.id === 'filter-all');
          } else {
            selectedSources.delete('all');
            cb.checked ? selectedSources.add(source) : selectedSources.delete(source);
            if (!selectedSources.size) selectedSources = new Set(['all']);
          }
          document.getElementById('filter-all').checked = selectedSources.has('all');
          displayFeedback();
        });
      });

      document.querySelectorAll('[data-sentiment]').forEach(opt => {
        opt.addEventListener('click', () => {
          const sentiment = opt.dataset.sentiment;
          const cb = opt.querySelector('input');
          cb.checked = !cb.checked;
          cb.checked ? selectedSentiments.add(sentiment) : selectedSentiments.delete(sentiment);
          displayFeedback();
        });
      });

      document.querySelectorAll('[data-urgency]').forEach(opt => {
        opt.addEventListener('click', () => {
          const urgency = opt.dataset.urgency;
          const cb = opt.querySelector('input');
          cb.checked = !cb.checked;
          cb.checked ? selectedUrgencies.add(urgency) : selectedUrgencies.delete(urgency);
          displayFeedback();
        });
      });

      document.querySelectorAll('.quick-action-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.getElementById('aiInput').value = btn.dataset.prompt;
          sendMessage();
        });
      });
    }

    function addMessage(type, text, isHtml = false) {
      const area = document.getElementById('messagesArea');
      const msg = document.createElement('div');
      msg.className = `message ${type}`;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      if (isHtml) {
        bubble.innerHTML = text;
      } else {
        bubble.textContent = text;
      }
      msg.appendChild(bubble);
      area.appendChild(msg);
      area.scrollTop = area.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById('aiInput');
      const query = input.value.trim();
      if (!query) return;

      addMessage('user', query);
      input.value = '';
      document.getElementById('quickActions').style.display = 'none';

      const lower = query.toLowerCase();
      let searchFilters = [];
      let results = [];

      // Show thinking process
      const thinking = [
        'üîç Analyzing your query...',
        'üìä Searching through feedback database...'
      ];

      let searchType = '';

      if (lower.includes('critical') || lower.includes('urgent') || lower.includes('priority')) {
        searchFilters = ['urgency = critical', 'sentiment = negative', 'source = support-ticket'];
        results = allFeedback.filter(f => f.urgency === 'critical' || f.sentiment === 'negative' || f.source === 'support-ticket');
        searchType = 'Critical Feedback';
        thinking.push('‚ö° Filtering for critical and urgent items...');
      } else if (lower.includes('high urgency') || lower.includes('high priority')) {
        searchFilters = ['urgency >= high'];
        results = allFeedback.filter(f => f.urgency === 'high' || f.urgency === 'critical');
        searchType = 'High Urgency Items';
        thinking.push('‚ö° Filtering for high urgency items...');
      } else if (lower.includes('negative') || lower.includes('complaint')) {
        searchFilters = ['sentiment = negative'];
        results = allFeedback.filter(f => f.sentiment === 'negative');
        searchType = 'Negative Feedback';
        thinking.push('üò† Finding complaints and negative feedback...');
      } else if (lower.includes('positive') || lower.includes('happy')) {
        searchFilters = ['sentiment = positive'];
        results = allFeedback.filter(f => f.sentiment === 'positive');
        searchType = 'Positive Feedback';
        thinking.push('üòä Finding praise and positive comments...');
      } else if (lower.includes('discord')) {
        searchFilters = ['source = discord'];
        results = allFeedback.filter(f => f.source === 'discord');
        searchType = 'Discord Messages';
        thinking.push('üí¨ Querying Discord channel...');
      } else if (lower.includes('email')) {
        searchFilters = ['source = email'];
        results = allFeedback.filter(f => f.source === 'email');
        searchType = 'Email Feedback';
        thinking.push('üìß Searching email inbox...');
      } else if (lower.includes('support') || lower.includes('ticket')) {
        searchFilters = ['source = support-ticket'];
        results = allFeedback.filter(f => f.source === 'support-ticket');
        searchType = 'Support Tickets';
        thinking.push('üé´ Checking support system...');
      } else {
        results = allFeedback;
        searchType = 'All Feedback';
        thinking.push('üìã Scanning entire feedback database...');
      }

      // Show thinking process
      const thinkingHtml = thinking.map(step => `<div style="margin: 4px 0; color: #aaa; font-size: 12px;">‚Üí ${step}</div>`).join('');
      addMessage('ai', `<div style="color: #888; margin-bottom: 8px;"><strong>üß† Thinking:</strong></div>${thinkingHtml}`, true);

      // Show search parameters
      if (searchFilters.length > 0) {
        const filtersHtml = searchFilters.map(f => `<span style="background: rgba(243, 128, 32, 0.1); padding: 2px 6px; border-radius: 3px; margin: 0 4px 0 0; display: inline-block; color: #F38020; font-size: 11px;">${f}</span>`).join('');
        addMessage('ai', `<div style="color: #888; font-size: 12px;"><strong>üîé Search Filters:</strong> ${filtersHtml}</div>`, true);
      }

      // Show results with clickable sources
      if (results.length === 0) {
        addMessage('ai', `‚úó No results found for "${searchType}". Try a different query!`);
      } else {
        const summary = `‚úì Found ${results.length} matching items`;
        addMessage('ai', summary);

        // Show top 3 results with sources
        results.slice(0, 3).forEach((item, idx) => {
          const sourceColor = {
            'email': '#60a5fa',
            'discord': '#7c3aed',
            'support-ticket': '#f59e0b',
            'twitter': '#3b82f6',
            'github-issue': '#6366f1'
          }[item.source] || '#888';

          const sourceEmoji = getEmoji(item.source);
          const resultHtml = `
            <div style="margin-top: 8px; padding: 8px; background: rgba(243, 128, 32, 0.05); border-left: 3px solid ${sourceColor}; border-radius: 4px;">
              <div style="color: ${sourceColor}; font-size: 11px; font-weight: 600; margin-bottom: 4px;">${sourceEmoji} ${item.source.toUpperCase()}</div>
              <div style="color: #d5d5d5; font-size: 12px; margin-bottom: 4px;">"${escapeHtml(item.content)}"</div>
              <div style="font-size: 11px; color: #888;">
                üìå Sentiment: <span style="color: ${item.sentiment === 'positive' ? '#22c55e' : item.sentiment === 'negative' ? '#ef4444' : '#888'}">${item.sentiment}</span>
                ‚ö° Urgency: <span style="color: ${item.urgency === 'critical' ? '#dc2626' : item.urgency === 'high' ? '#f97316' : '#888'}">${item.urgency}</span>
                ${item.author ? `üë§ Author: ${escapeHtml(item.author)}` : ''}
              </div>
            </div>
          `;
          addMessage('ai', resultHtml, true);
        });

        // Show sources at the end
        if (results.length > 0) {
          const sources = [...new Set(results.map(r => r.source))];
          const sourcesHtml = sources.map(s => {
            const count = results.filter(r => r.source === s).length;
            return `<button onclick="document.querySelectorAll('[data-source=\\\"${s}\\\"]')[0]?.click(); document.getElementById('rightPanel').scrollIntoView({behavior: 'smooth'});" style="background: rgba(243, 128, 32, 0.1); border: 1px solid rgba(243, 128, 32, 0.25); color: #F38020; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; margin: 4px 4px 4px 0; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(243, 128, 32, 0.2)'" onmouseout="this.style.background='rgba(243, 128, 32, 0.1)'">üìå ${getEmoji(s)} ${s} (${count})</button>`;
          }).join('');
          addMessage('ai', `<div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);"><strong style="color: #888; font-size: 11px;">üìç SOURCES (Click to filter):</strong><div style="margin-top: 6px;">${sourcesHtml}</div></div>`, true);
        }
      }
    }

    function escapeHtml(text) {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
